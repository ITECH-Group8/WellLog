{% extends 'base_with_sidebar.html' %}
{% load static %}

{% block title %}Health Record History{% endblock %}

{% block css %}
{{ block.super }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
<style>
  /* History page optimized styles */
  .history-container {
    padding: 1rem;
  }
  
  .history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }
  
  .history-header h2 {
    font-size: 2.0rem;
    font-weight: 600;
    margin: 0;
  }
  
  .history-header h2 i {
    font-size: 1.2rem;
  }
  
  /* Navigation tabs styles */
  .nav-tabs .nav-link {
    font-size: 0.9rem;
    padding: 0.5rem 0.8rem;
    border-radius: 5px 5px 0 0;
    font-weight: 500;
  }
  
  .nav-tabs .nav-link i {
    font-size: 0.9rem;
  }
  
  .nav-tabs .nav-link.active {
    background-color: #f8f9fa;
    border-bottom-color: #f8f9fa;
  }
  
  .dashboard-header {
    margin-bottom: 1rem !important;
  }
  
  .export-btn {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    display: inline-flex;
    align-items: center;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .export-btn:hover {
    background-color: #e9ecef;
  }
  
  .export-btn i {
    margin-right: 0.3rem;
    font-size: 0.8rem;
  }
  
  /* Statistics card optimized */
  .summary-stats {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  
  .stat-card {
    background: white;
    border-radius: 0.5rem;
    padding: 0.8rem 1rem;
    flex: 1;
    min-width: 120px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    text-align: center;
    transition: transform 0.2s;
  }
  
  .stat-card:hover {
    transform: translateY(-3px);
  }
  
  .stat-title {
    font-size: 0.8rem;
    color: #6c757d;
    margin-bottom: 0.3rem;
  }
  
  .stat-value {
    font-size: 1.5rem;
    font-weight: 600;
    color: #212529;
  }
  
  /* Chart area optimized - adaptive size */
  .chart-container {
    background: white;
    border-radius: 0.5rem;
    padding: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    width: 100%;
    margin: 0 auto 1.5rem auto;
  }
  
  /* Chart wrapper container */
  .chart-wrapper {
    position: relative;
    width: 100%;
    height: auto;
    min-height: 250px;
    max-height: 450px;
  }
  
  .chart-types {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }
  
  .chart-type-btn {
    padding: 0.3rem 0.6rem;
    font-size: 0.8rem;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .chart-type-btn.active {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
  }
  
  /* Filter card */
  .filter-card {
    background: white;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }
  
  .filter-buttons {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
    flex-wrap: wrap;
  }
  
  /* Data table optimized */
  .history-card {
    background: white;
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }
  
  .history-card .card-header {
    padding: 0.75rem 1rem;
    background-color: #f8f9fa;
    border-bottom: 1px solid rgba(0,0,0,0.05);
  }
  
  .history-card .card-header h5 {
    font-size: 1rem;
    margin: 0;
  }
  
  .history-table {
    width: 100%;
    border-collapse: collapse;
  }
  
  .history-table th,
  .history-table td {
    padding: 0.6rem 0.8rem;
    border-bottom: 1px solid #e9ecef;
  }
  
  .history-table th {
    background-color: #f8f9fa;
    font-weight: 500;
    text-align: left;
  }
  
  .action-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: 0.25rem;
    margin-right: 0.3rem;
    transition: all 0.2s;
  }
  
  .action-btn.edit {
    background-color: #e9ecef;
    color: #495057;
  }
  
  .action-btn.delete {
    background-color: #f8d7da;
    color: #dc3545;
  }
  
  .action-btn:hover {
    opacity: 0.8;
  }
  
  /* Empty state optimized */
  .empty-state {
    text-align: center;
    padding: 2rem 1rem;
  }
  
  .empty-state i {
    font-size: 2rem;
    color: #adb5bd;
    margin-bottom: 1rem;
  }
  
  /* Pagination optimized */
  .pagination {
    margin-top: 1rem;
    justify-content: center;
  }
  
  /* Responsive adjustment */
  @media (max-width: 576px) {
    .chart-wrapper {
      min-height: 200px;
    }
    
    .history-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.5rem;
    }
    
    .chart-type-btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
    }
    
    .stat-card {
      min-width: 100px;
      padding: 0.6rem 0.8rem;
    }
    
    .stat-value {
      font-size: 1.25rem;
    }
  }
  
  @media (min-width: 577px) and (max-width: 991px) {
    .chart-wrapper {
      min-height: 300px;
    }
  }
  
  @media (min-width: 992px) {
    .chart-wrapper {
      min-height: 400px;
    }
  }
  
  /* Animation delay classes */
  .delay-0 { animation-delay: 0s; }
  .delay-1 { animation-delay: 0.1s; }
  .delay-2 { animation-delay: 0.2s; }
  .delay-3 { animation-delay: 0.3s; }
  .delay-4 { animation-delay: 0.4s; }
  .delay-5 { animation-delay: 0.5s; }
  .delay-6 { animation-delay: 0.6s; }
  .delay-7 { animation-delay: 0.7s; }
  .delay-8 { animation-delay: 0.8s; }
  .delay-9 { animation-delay: 0.9s; }
  .delay-10 { animation-delay: 1.0s; }
  .delay-11 { animation-delay: 1.1s; }
  .delay-12 { animation-delay: 1.2s; }
  .delay-13 { animation-delay: 1.3s; }
  .delay-14 { animation-delay: 1.4s; }
  .delay-15 { animation-delay: 1.5s; }
</style>
{% endblock %}

{% block content %}
<!-- Health record history content -->
<div class="container-fluid py-4">
  <div class="history-container animate__animated animate__fadeIn">
    <div class="history-header">
      <h2>
        {{ record_type }} Record History
      </h2>
    </div>
    
    <!-- Add navigation tabs -->
    <div class="dashboard-header d-flex justify-content-between align-items-center mb-4">
      <ul class="nav nav-tabs" id="healthTabs">
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'overall' %}active{% endif %}" href="{% url 'dashboard' %}">
            <i class="bi bi-grid-3x3-gap me-1"></i>Overall
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'running' %}active{% endif %}" href="{% url 'running_history' %}">
            <i class="bi bi-lightning me-1"></i>Running
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'step' %}active{% endif %}" href="{% url 'steps_history' %}">
            <i class="bi bi-activity me-1"></i>Steps
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'training' %}active{% endif %}" href="{% url 'training_history' %}">
            <i class="bi bi-trophy me-1"></i>Training
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'sleep' %}active{% endif %}" href="{% url 'sleep_history' %}">
            <i class="bi bi-moon me-1"></i>Sleep
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'diet' %}active{% endif %}" href="{% url 'diet_history' %}">
            <i class="bi bi-egg-fried me-1"></i>Diet
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'mood' %}active{% endif %}" href="{% url 'mood_history' %}">
            <i class="bi bi-emoji-smile me-1"></i>Mood
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'weight' %}active{% endif %}" href="{% url 'weight_history' %}">
            <i class="bi bi-clipboard-data me-1"></i>Weight
          </a>
        </li>
      </ul>
      <div>
        {% if record_type == 'Steps' %}
          <a href="{% url 'steps_add' %}" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-circle me-1"></i> Add Steps Record
          </a>
        {% elif record_type == 'Sleep' %}
          <a href="{% url 'sleep_add' %}" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-circle me-1"></i> Add Sleep Record
          </a>
        {% elif record_type == 'Diet' %}
          <a href="{% url 'diet_add' %}" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-circle me-1"></i> Add Diet Record
          </a>
        {% elif record_type == 'Running' %}
          <a href="{% url 'running_add' %}" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-circle me-1"></i> Add Running Record
          </a>
        {% elif record_type == 'Mood' %}
          <a href="{% url 'mood_add' %}" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-circle me-1"></i> Add Mood Record
          </a>
        {% elif record_type == 'Weight' %}
          <a href="{% url 'weight_add' %}" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-circle me-1"></i> Add Weight Record
          </a>
        {% endif %}
      </div>
    </div>
    
    <!-- Statistics summary -->
    <div class="summary-stats">
      <div class="stat-card animate__animated animate__fadeInUp delay-0">
        <div class="stat-title">Record Total</div>
        <div class="stat-value">{{ records|length }}</div>
      </div>
      
      {% if record_type == 'Steps' %}
      <div class="stat-card animate__animated animate__fadeInUp delay-1">
        <div class="stat-title">Average Steps</div>
        <div class="stat-value">{{ avg_steps|default:"0" }}</div>
      </div>
      <div class="stat-card animate__animated animate__fadeInUp delay-2">
        <div class="stat-title">Maximum Steps</div>
        <div class="stat-value">{{ max_steps|default:"0" }}</div>
      </div>
      {% elif record_type == 'Sleep' %}
      <div class="stat-card animate__animated animate__fadeInUp delay-1">
        <div class="stat-title">Average Sleep Duration</div>
        <div class="stat-value">{{ avg_sleep|default:"0" }}h</div>
      </div>
      <div class="stat-card animate__animated animate__fadeInUp delay-2">
        <div class="stat-title">Average Sleep Quality</div>
        <div class="stat-value">{{ avg_quality|default:"Good" }}</div>
      </div>
      {% elif record_type == 'Diet' %}
      <div class="stat-card animate__animated animate__fadeInUp delay-1">
        <div class="stat-title">Average Calories</div>
        <div class="stat-value">{{ avg_calories|default:"0" }}</div>
      </div>
      <div class="stat-card animate__animated animate__fadeInUp delay-2">
        <div class="stat-title">Average Protein</div>
        <div class="stat-value">{{ avg_protein|default:"0" }}g</div>
      </div>
      {% elif record_type == 'Running' %}
      <div class="stat-card animate__animated animate__fadeInUp delay-1">
        <div class="stat-title">Total Distance</div>
        <div class="stat-value">{{ total_distance|default:"0" }}km</div>
      </div>
      <div class="stat-card animate__animated animate__fadeInUp delay-2">
        <div class="stat-title">Average Pace</div>
        <div class="stat-value">{{ avg_pace|default:"0" }}min/km</div>
      </div>
      {% elif record_type == 'Weight' %}
      <div class="stat-card animate__animated animate__fadeInUp delay-1">
        <div class="stat-title">Average Weight</div>
        <div class="stat-value">{{ avg_weight|default:"0" }}kg</div>
      </div>
      <div class="stat-card animate__animated animate__fadeInUp delay-2">
        <div class="stat-title">Average BMI</div>
        <div class="stat-value">{{ avg_bmi|default:"0" }}</div>
      </div>
      {% endif %}
    </div>
    
    <!-- Chart area - adaptive size -->
    <div class="chart-container mb-4 animate__animated animate__fadeInUp delay-3">
      <div class="chart-types">
        <button class="chart-type-btn {% if chart_type == 'line' or not chart_type %}active{% endif %}" data-chart-type="line">Line Chart</button>
        <button class="chart-type-btn {% if chart_type == 'bar' %}active{% endif %}" data-chart-type="bar">Bar Chart</button>
        <button class="chart-type-btn {% if chart_type == 'pie' %}active{% endif %}" data-chart-type="pie">Pie Chart</button>
      </div>
      <div class="chart-wrapper">
        <canvas id="recordChart"></canvas>
      </div>
    </div>
    
    <!-- Filter - default display current data range -->
    <div class="filter-card animate__animated animate__fadeInUp delay-4">
      <form method="get" action="" id="dateFilterForm">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="date_from" class="form-label">Start Date</label>
              <input type="date" class="form-control" id="date_from" name="date_from" 
                     value="{{ date_from|default:'' }}">
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label for="date_to" class="form-label">End Date</label>
              <input type="date" class="form-control" id="date_to" name="date_to" 
                     value="{{ date_to|default:'' }}">
            </div>
          </div>
        </div>
        <!-- Add a hidden input field to save the current chart type -->
        <input type="hidden" name="chart_type" id="chartTypeInput" value="{{ chart_type|default:'line' }}">
        <p class="text-muted small mb-2"><i class="bi bi-info-circle me-1"></i>If no date is set, the date range of existing records will be used</p>
        <div class="filter-buttons">
          <button type="submit" class="btn btn-primary btn-sm">
            <i class="bi bi-filter me-1"></i>Filter
          </button>
          {% if record_type == 'Steps' %}
            <a href="{% url 'steps_history' %}" class="btn btn-outline-secondary btn-sm" id="resetButton">
              <i class="bi bi-x-circle me-1"></i>Reset
            </a>
          {% elif record_type == 'Sleep' %}
            <a href="{% url 'sleep_history' %}" class="btn btn-outline-secondary btn-sm" id="resetButton">
              <i class="bi bi-x-circle me-1"></i>Reset
            </a>
          {% elif record_type == 'Diet' %}
            <a href="{% url 'diet_history' %}" class="btn btn-outline-secondary btn-sm" id="resetButton">
              <i class="bi bi-x-circle me-1"></i>Reset
            </a>
          {% elif record_type == 'Running' %}
            <a href="{% url 'running_history' %}" class="btn btn-outline-secondary btn-sm" id="resetButton">
              <i class="bi bi-x-circle me-1"></i>Reset
            </a>
          {% elif record_type == 'Mood' %}
            <a href="{% url 'mood_history' %}" class="btn btn-outline-secondary btn-sm" id="resetButton">
              <i class="bi bi-x-circle me-1"></i>Reset
            </a>
          {% elif record_type == 'Weight' %}
            <a href="{% url 'weight_history' %}" class="btn btn-outline-secondary btn-sm" id="resetButton">
              <i class="bi bi-x-circle me-1"></i>Reset
            </a>
          {% endif %}
        </div>
      </form>
    </div>
    
    <!-- Data record table -->
    <div class="history-card animate__animated animate__fadeInUp delay-5">
      <div class="card-header">
        <h5>{{ record_type }} Record List</h5>
      </div>
      <div class="card-body">
        {% if records %}
          <div class="table-responsive">
            <table class="history-table">
              <thead>
                <tr>
                  <th>Date</th>
                  {% if record_type == 'Steps' %}
                    <th>Steps</th>
                  {% elif record_type == 'Sleep' %}
                    <th>Hours</th>
                    <th>Minutes</th>
                    <th>Quality</th>
                  {% elif record_type == 'Diet' %}
                    <th>Calories</th>
                    <th>Protein (g)</th>
                    <th>Carbs (g)</th>
                    <th>Fat (g)</th>
                  {% elif record_type == 'Running' %}
                    <th>Distance (km)</th>
                    <th>Duration (minutes)</th>
                    <th>Calories Burned</th>
                  {% elif record_type == 'Mood' %}
                    <th>Mood</th>
                    <th>Stress Level</th>
                  {% elif record_type == 'Weight' %}
                    <th>Weight (kg)</th>
                    <th>BMI</th>
                  {% endif %}
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for record in records %}
                  {% with delay_index=forloop.counter0|floatformat:0 %}
                  <tr class="animate__animated animate__fadeIn delay-{{ delay_index }}">
                  {% endwith %}
                    <td>{{ record.date|date:"Y-m-d" }}</td>
                    {% if record_type == 'Steps' %}
                      <td>{{ record.steps_count }}</td>
                    {% elif record_type == 'Sleep' %}
                      <td>{{ record.hours }}</td>
                      <td>{{ record.minutes }}</td>
                      <td>{{ record.quality|default:"Not Specified" }}</td>
                    {% elif record_type == 'Diet' %}
                      <td>{{ record.calories }}</td>
                      <td>{{ record.protein }}</td>
                      <td>{{ record.carbs }}</td>
                      <td>{{ record.fat }}</td>
                    {% elif record_type == 'Running' %}
                      <td>{{ record.distance }}</td>
                      <td>{{ record.duration }}</td>
                      <td>{{ record.calories_burned }}</td>
                    {% elif record_type == 'Mood' %}
                      <td>
                        {% if record.mood == 'excellent' %}😁 Excellent
                        {% elif record.mood == 'good' %}😊 Good
                        {% elif record.mood == 'neutral' %}😐 Neutral
                        {% elif record.mood == 'bad' %}😔 Bad
                        {% elif record.mood == 'terrible' %}😢 Terrible
                        {% endif %}
                      </td>
                      <td>{{ record.stress_level|default:"Not Specified" }}</td>
                    {% elif record_type == 'Weight' %}
                      <td>{{ record.weight }}</td>
                      <td>{{ record.bmi }}</td>
                    {% endif %}
                    <td>
                      {% if record_type == 'Steps' %}
                        <a href="{% url 'steps_edit' record.id %}" class="action-btn edit">
                          <i class="bi bi-pencil"></i>
                        </a>
                        <a href="{% url 'steps_delete' record.id %}" class="action-btn delete">
                          <i class="bi bi-trash"></i>
                        </a>
                      {% elif record_type == 'Sleep' %}
                        <a href="{% url 'sleep_edit' record.id %}" class="action-btn edit">
                          <i class="bi bi-pencil"></i>
                        </a>
                        <a href="{% url 'sleep_delete' record.id %}" class="action-btn delete">
                          <i class="bi bi-trash"></i>
                        </a>
                      {% elif record_type == 'Diet' %}
                        <a href="{% url 'diet_edit' record.id %}" class="action-btn edit">
                          <i class="bi bi-pencil"></i>
                        </a>
                        <a href="{% url 'diet_delete' record.id %}" class="action-btn delete">
                          <i class="bi bi-trash"></i>
                        </a>
                      {% elif record_type == 'Running' %}
                        <a href="{% url 'running_edit' record.id %}" class="action-btn edit">
                          <i class="bi bi-pencil"></i>
                        </a>
                        <a href="{% url 'running_delete' record.id %}" class="action-btn delete">
                          <i class="bi bi-trash"></i>
                        </a>
                      {% elif record_type == 'Mood' %}
                        <a href="{% url 'mood_edit' record.id %}" class="action-btn edit">
                          <i class="bi bi-pencil"></i>
                        </a>
                        <a href="{% url 'mood_delete' record.id %}" class="action-btn delete">
                          <i class="bi bi-trash"></i>
                        </a>
                      {% elif record_type == 'Weight' %}
                        <a href="{% url 'weight_edit' record.id %}" class="action-btn edit">
                          <i class="bi bi-pencil"></i>
                        </a>
                        <a href="{% url 'weight_delete' record.id %}" class="action-btn delete">
                          <i class="bi bi-trash"></i>
                        </a>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          
          <!-- Pagination -->
          {% if is_paginated %}
            <nav aria-label="Page navigation">
              <ul class="pagination">
                {% if page_obj.has_previous %}
                  <li class="page-item">
                    <a class="page-link" href="?page=1{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if chart_type %}&chart_type={{ chart_type }}{% endif %}" aria-label="First">
                      <span aria-hidden="true">&laquo;&laquo;</span>
                    </a>
                  </li>
                  <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if chart_type %}&chart_type={{ chart_type }}{% endif %}" aria-label="Previous">
                      <span aria-hidden="true">&laquo;</span>
                    </a>
                  </li>
                {% endif %}
                
                {% for num in page_obj.paginator.page_range %}
                  {% if page_obj.number == num %}
                    <li class="page-item active">
                      <span class="page-link">{{ num }}</span>
                    </li>
                  {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item">
                      <a class="page-link" href="?page={{ num }}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if chart_type %}&chart_type={{ chart_type }}{% endif %}">{{ num }}</a>
                    </li>
                  {% endif %}
                {% endfor %}
                
                {% if page_obj.has_next %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if chart_type %}&chart_type={{ chart_type }}{% endif %}" aria-label="Next">
                      <span aria-hidden="true">&raquo;</span>
                    </a>
                  </li>
                  <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if chart_type %}&chart_type={{ chart_type }}{% endif %}" aria-label="Last">
                      <span aria-hidden="true">&raquo;&raquo;</span>
                    </a>
                  </li>
                {% endif %}
              </ul>
            </nav>
          {% endif %}
        {% else %}
          <div class="empty-state">
            <i class="bi bi-clipboard-x"></i>
            <h5>No Records</h5>
            <p>You haven't added any {{ record_type }} records</p>
            {% if record_type == 'Steps' %}
              <a href="{% url 'steps_add' %}" class="btn btn-outline-success btn-sm mt-3">
                <i class="bi bi-plus-lg"></i> Add Steps Record
              </a>
            {% elif record_type == 'Sleep' %}
              <a href="{% url 'sleep_add' %}" class="btn btn-outline-success btn-sm mt-3">
                <i class="bi bi-plus-lg"></i> Add Sleep Record
              </a>
            {% elif record_type == 'Diet' %}
              <a href="{% url 'diet_add' %}" class="btn btn-outline-success btn-sm mt-3">
                <i class="bi bi-plus-lg"></i> Add Diet Record
              </a>
            {% elif record_type == 'Running' %}
              <a href="{% url 'running_add' %}" class="btn btn-outline-success btn-sm mt-3">
                <i class="bi bi-plus-lg"></i> Add Running Record
              </a>
            {% elif record_type == 'Mood' %}
              <a href="{% url 'mood_add' %}" class="btn btn-outline-success btn-sm mt-3">
                <i class="bi bi-plus-lg"></i> Add Mood Record
              </a>
            {% elif record_type == 'Weight' %}
              <a href="{% url 'weight_add' %}" class="btn btn-outline-success btn-sm mt-3">
                <i class="bi bi-plus-lg"></i> Add Weight Record
              </a>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block javascript %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Get the chart_type parameter from the current URL, if not set default to 'line'
    const params = new URLSearchParams(window.location.search);
    const chartType = params.get('chart_type') || 'line';
    
    // Initialize charts
    initCharts(chartType);
    
    // Chart type switch
    document.querySelectorAll('.chart-type-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.chart-type-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        // Update the hidden input field value to ensure the form submission includes the current chart type
        document.getElementById('chartTypeInput').value = this.dataset.chartType;
        
        initCharts(this.dataset.chartType);
      });
    });
    
    // Fix navigation links requiring double-click issue
    const navLinks = document.querySelectorAll('#healthTabs .nav-link');
    navLinks.forEach(link => {
      // Create a new link element
      const newLink = document.createElement('a');
      
      // Copy all attributes of the original link
      newLink.className = link.className;
      newLink.href = link.href;
      newLink.innerHTML = link.innerHTML;
      
      // Remove all Bootstrap tabs related attributes and events
      newLink.removeAttribute('data-bs-toggle');
      newLink.removeAttribute('role');
      newLink.removeAttribute('aria-controls');
      newLink.removeAttribute('aria-selected');
      
      // Replace the original link
      if (link.parentNode) {
        link.parentNode.replaceChild(newLink, link);
      }
    });
    
    // Ensure reset buttons are not prevented by events
    const resetButton = document.getElementById('resetButton');
    if (resetButton) {
      const newResetButton = resetButton.cloneNode(true);
      if (resetButton.parentNode) {
        resetButton.parentNode.replaceChild(newResetButton, resetButton);
      }
      
      // When the reset button is clicked, ensure all filters are completely reset
      newResetButton.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Clear form input fields
        document.getElementById('date_from').value = '';
        document.getElementById('date_to').value = '';
        document.getElementById('chartTypeInput').value = 'line';
        
        // Directly jump to URL without parameters
        window.location.href = this.getAttribute('href');
      });
    }
    
    // Initialize date filters and immediately set values
    initDateFilters();
    
    // Optimize date filter submission
    document.getElementById('dateFilterForm').addEventListener('submit', function(e) {
      // No longer prevent default submission, use form native submission
      // e.preventDefault(); 
      
      const dateFrom = document.getElementById('date_from');
      const dateTo = document.getElementById('date_to');
      
      // Ensure date is valid
      if (dateFrom.value && dateTo.value) {
        const fromDate = new Date(dateFrom.value);
        const toDate = new Date(dateTo.value);
        
        if (fromDate > toDate) {
          e.preventDefault();
          alert('Start date cannot be later than end date');
          return false;
        }
      }
      
      // Use form native submission without manually building URL
      return true;
    });
  });
  
  // Initialize date filters
  function initDateFilters() {
    {% if chart_dates %}
      const chartDates = {{ chart_dates|safe }};
      if (chartDates && chartDates.length > 0) {
        const dateFrom = document.getElementById('date_from');
        const dateTo = document.getElementById('date_to');
        
        // Ensure always set valid default date range
        if (!dateFrom.value && chartDates.length > 0) {
          dateFrom.value = chartDates[0];
          console.log('Set start date:', dateFrom.value);
        }
        
        if (!dateTo.value && chartDates.length > 0) {
          dateTo.value = chartDates[chartDates.length - 1];
          console.log('Set end date:', dateTo.value);
        }
      }
    {% else %}
      console.log('No available date data to set default filter range');
    {% endif %}
    
    // Get date values from URL parameters and set to form
    const urlParams = new URLSearchParams(window.location.search);
    const fromParam = urlParams.get('date_from');
    const toParam = urlParams.get('date_to');
    
    if (fromParam) {
      document.getElementById('date_from').value = fromParam;
      console.log('Set start date from URL:', fromParam);
    }
    
    if (toParam) {
      document.getElementById('date_to').value = toParam;
      console.log('Set end date from URL:', toParam);
    }
  }
  
  // Initialize charts
  function initCharts(type) {
    const ctx = document.getElementById('recordChart').getContext('2d');
    let chartData = {};
    let chartOptions = {};
    
    {% if chart_dates and chart_data %}
      const chartDates = {{ chart_dates|safe }};
      const chartValues = {{ chart_data|safe }};
      
      // Calculate suitable axis range for weight chart
      {% if record_type == 'Weight' %}
      const bmiValues = {{ chart_bmi_data|safe }};
      const [weightMin, weightMax] = calculateAxisRange(chartValues);
      const [bmiMin, bmiMax] = calculateAxisRange(bmiValues);
      {% endif %}
      
      // Basic dataset configuration options - applied to all charts to solve scratching issues
      const commonDatasetConfig = {
        borderWidth: 2,
        tension: 0.2,
        fill: type === 'line',
        cubicInterpolationMode: 'monotone',
        borderJoinStyle: 'round',
        stepped: false,
        pointRadius: 3
      };
      
      {% if record_type == 'Steps' %}
        chartData = {
          labels: chartDates,
          datasets: [{
            label: 'Steps',
            data: chartValues,
            backgroundColor: 'rgba(40, 167, 69, 0.7)',
            borderColor: 'rgba(40, 167, 69, 1)',
            ...commonDatasetConfig
          }]
        };
      {% elif record_type == 'Sleep' %}
        chartData = {
          labels: chartDates,
          datasets: [{
            label: 'Sleep Duration (hours)',
            data: chartValues,
            backgroundColor: 'rgba(111, 66, 193, 0.7)',
            borderColor: 'rgba(111, 66, 193, 1)',
            ...commonDatasetConfig
          }]
        };
      {% elif record_type == 'Diet' %}
        chartData = {
          labels: chartDates,
          datasets: [{
            label: 'Calories',
            data: chartValues,
            backgroundColor: 'rgba(220, 53, 69, 0.7)',
            borderColor: 'rgba(220, 53, 69, 1)',
            ...commonDatasetConfig
          }]
        };
      {% elif record_type == 'Running' %}
        chartData = {
          labels: chartDates,
          datasets: [{
            label: 'Distance (km)',
            data: chartValues,
            backgroundColor: 'rgba(13, 110, 253, 0.7)',
            borderColor: 'rgba(13, 110, 253, 1)',
            ...commonDatasetConfig
          }]
        };
      {% elif record_type == 'Mood' %}
        chartData = {
          labels: chartDates,
          datasets: [{
            label: 'Mood Level',
            data: chartValues,
            backgroundColor: 'rgba(255, 193, 7, 0.7)',
            borderColor: 'rgba(255, 193, 7, 1)',
            ...commonDatasetConfig
          }]
        };
      {% elif record_type == 'Weight' %}
        chartData = {
          labels: chartDates,
          datasets: [
            {
              label: 'Weight (kg)',
              data: chartValues,
              backgroundColor: 'rgba(54, 162, 235, 0.2)',
              borderColor: 'rgba(54, 162, 235, 1)',
              ...commonDatasetConfig,
              yAxisID: 'y'
            },
            {
              label: 'BMI',
              data: {{ chart_bmi_data|safe }},
              backgroundColor: 'rgba(255, 99, 132, 0.2)',
              borderColor: 'rgba(255, 99, 132, 1)',
              ...commonDatasetConfig,
              yAxisID: 'y1'
            }
          ]
        };
        
        // Set special configuration for weight chart
        chartOptions = {
          scales: {
            y: {
              beginAtZero: false,
              min: weightMin,
              max: weightMax,
              ticks: {
                font: { size: 11 }
              },
              title: {
                display: true,
                text: 'Weight (kg)'
              }
            },
            y1: {
              beginAtZero: false,
              min: bmiMin,
              max: bmiMax,
              position: 'right',
              grid: {
                drawOnChartArea: false
              },
              ticks: {
                font: { size: 11 }
              },
              title: {
                display: true,
                text: 'BMI'
              }
            },
            x: {
              ticks: {
                font: { size: 11 },
                maxRotation: 45,
                minRotation: 0
              },
              grid: { display: false }
            }
          }
        };
      {% endif %}
    {% else %}
      // Empty chart when no data
      chartData = {
        labels: [],
        datasets: [{
          label: 'No Data',
          data: [],
          backgroundColor: 'rgba(108, 117, 125, 0.7)',
          borderColor: 'rgba(108, 117, 125, 1)',
        }]
      };
    {% endif %}
    
    // Destroy old chart (if exists)
    if (window.recordChart instanceof Chart) {
      window.recordChart.destroy();
    }
    
    // Create new chart - fully adaptive
    window.recordChart = new Chart(ctx, {
      type: type,
      data: chartData,
      options: Object.assign({
        responsive: true,
        maintainAspectRatio: false,
        animation: {
          duration: 800,
          easing: 'easeOutQuart'
        },
        elements: {
          line: {
            tension: 0.2,
            borderJoinStyle: 'round',
            capBezierPoints: true
          },
          point: {
            radius: 3,
            hoverRadius: 5
          }
        },
        plugins: {
          legend: {
            position: 'top',
            labels: {
              boxWidth: 12,
              padding: 8,
              font: {
                size: 12
              }
            }
          },
          title: {
            display: true,
            text: '{{ record_type }} History Trend',
            font: {
              size: 14
            },
            padding: {
              top: 10,
              bottom: 10
            }
          },
          tooltip: {
            titleFont: {
              size: 13
            },
            bodyFont: {
              size: 12
            },
            padding: 10
          }
        },
        scales: {
          y: {
            {% if record_type != 'Weight' %}
            beginAtZero: true,
            {% endif %}
            ticks: {
              font: {
                size: 11
              }
            },
            grid: {
              display: true,
              color: 'rgba(0, 0, 0, 0.05)'
            }
          },
          x: {
            ticks: {
              font: {
                size: 11
              },
              maxRotation: 45,
              minRotation: 0
            },
            grid: {
              display: false
            }
          }
        },
        layout: {
          padding: {
            left: 10,
            right: 10,
            top: 10,
            bottom: 10
          }
        }
      }, chartOptions)
    });
  }
  
  /**
   * Calculate suitable axis range to better display data changes
   * @param {Array} values - Array of data values
   * @return {Array} - [min, max] Minimum and maximum values
   */
  function calculateAxisRange(values) {
    if (!values || values.length === 0) {
      return [0, 100]; // Default range
    }
    
    // Find minimum and maximum values in data
    const min = Math.min(...values);
    const max = Math.max(...values);
    
    // Calculate data range
    const range = max - min;
    
    // If range is very small, we expand a bit for better visualization
    if (range < 0.5) {
      // Very small change, expand view range
      return [min - 0.5, max + 0.5];
    } else if (range < 2) {
      // Small range change
      return [min - 0.2 * range, max + 0.2 * range];
    } else if (range < 5) {
      // Medium range change
      return [min - 0.1 * range, max + 0.1 * range];
    } else {
      // Large range change
      return [min - 0.05 * range, max + 0.05 * range];
    }
  }
</script>
{% endblock %} 