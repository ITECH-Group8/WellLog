{% extends 'health/dashboard.html' %}

{% block content %}
<!-- Mobile Menu Toggle Button -->
<button class="menu-toggle d-md-none d-block btn">
  <i class="bi bi-list"></i>
</button>

<!-- Left Sidebar -->
<div class="sidebar">
  <div class="sidebar-logo text-center">
    <img src="https://via.placeholder.com/80" class="rounded-circle mb-2" alt="Logo" width="60" height="60">
    <h5>WellLog</h5>
  </div>
  <ul class="nav flex-column px-3">
    <li class="nav-item">
      <a href="{% url 'dashboard' %}" class="nav-link {% if active_tab == 'overall' %}active{% else %}{% endif %} d-flex align-items-center">
        <i class="bi bi-speedometer2"></i>
        <span>Dashboard</span>
      </a>
    </li>
    <li class="nav-item">
      <a href="{% url 'community_list' %}" class="nav-link d-flex align-items-center">
        <i class="bi bi-people"></i>
        <span>Community</span>
      </a>
    </li>
    <li class="nav-item">
      <a href="#" class="nav-link d-flex align-items-center">
        <i class="bi bi-robot"></i>
        <span>AI Advice</span>
      </a>
    </li>
    <li class="nav-item mt-5">
      <a href="{% url 'account_logout' %}" class="nav-link d-flex align-items-center">
        <i class="bi bi-box-arrow-right"></i>
        <span>Logout</span>
      </a>
    </li>
    <li class="nav-item">
      <a href="#" class="nav-link d-flex align-items-center">
        <i class="bi bi-gear"></i>
        <span>Settings</span>
      </a>
    </li>
  </ul>
</div>

<!-- Main Content Area -->
<div class="main-content">
  <!-- Navigation Tabs -->
  <div class="dashboard-header d-flex justify-content-between align-items-center mb-4">
    <ul class="nav nav-tabs">
      <li class="nav-item">
        <a class="nav-link {% if active_tab == 'overall' %}active{% endif %}" href="{% url 'dashboard' %}">Overview</a>
      </li>
      <li class="nav-item">
        <a class="nav-link {% if active_tab == 'running' %}active{% endif %}" href="{% url 'running_history' %}">Running</a>
      </li>
      <li class="nav-item">
        <a class="nav-link {% if active_tab == 'step' %}active{% endif %}" href="{% url 'steps_history' %}">Steps</a>
      </li>
      <li class="nav-item">
        <a class="nav-link {% if active_tab == 'training' %}active{% endif %}" href="{% url 'training_history' %}">Training</a>
      </li>
      <li class="nav-item">
        <a class="nav-link {% if active_tab == 'sleep' %}active{% endif %}" href="{% url 'sleep_history' %}">Sleep</a>
      </li>
      <li class="nav-item">
        <a class="nav-link {% if active_tab == 'diet' %}active{% endif %}" href="{% url 'diet_history' %}">Diet</a>
      </li>
      <li class="nav-item">
        <a class="nav-link {% if active_tab == 'mood' %}active{% endif %}" href="{% url 'mood_history' %}">Mood</a>
      </li>
    </ul>
    <div>
      <a href="
      {% if active_tab == 'step' %}{% url 'steps_add' %}
      {% elif active_tab == 'sleep' %}{% url 'sleep_add' %}
      {% elif active_tab == 'diet' %}{% url 'diet_add' %}
      {% elif active_tab == 'running' %}{% url 'running_add' %}
      {% elif active_tab == 'training' %}{% url 'training_add' %}
      {% elif active_tab == 'mood' %}{% url 'mood_add' %}
      {% else %}#{% endif %}" class="btn btn-primary">
        <i class="bi bi-plus-circle me-1"></i> Add {{ record_type }} Record
      </a>
    </div>
  </div>
  
  <!-- Chart -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-light">
      <h5>{{ record_type }} History - Last 30 Days</h5>
    </div>
    <div class="card-body">
      <canvas id="recordChart" height="300"></canvas>
    </div>
  </div>
  
  <!-- Records Table -->
  <div class="card shadow-sm">
    <div class="card-header bg-light">
      <h5>{{ record_type }} Records</h5>
    </div>
    <div class="card-body">
      {% if records %}
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-light">
              <tr>
                <th>Date</th>
                {% if record_type == 'Steps' %}
                  <th>Steps Count</th>
                {% elif record_type == 'Sleep' %}
                  <th>Hours</th>
                  <th>Minutes</th>
                  <th>Quality</th>
                {% elif record_type == 'Diet' %}
                  <th>Calories</th>
                  <th>Protein (g)</th>
                  <th>Carbs (g)</th>
                  <th>Fat (g)</th>
                {% elif record_type == 'Running' %}
                  <th>Distance (km)</th>
                  <th>Duration (min)</th>
                  <th>Calories Burned</th>
                {% elif record_type == 'Mood' %}
                  <th>Mood</th>
                  <th>Stress Level</th>
                {% endif %}
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for record in records %}
                <tr>
                  <td>{{ record.date }}</td>
                  {% if record_type == 'Steps' %}
                    <td>{{ record.steps_count }}</td>
                  {% elif record_type == 'Sleep' %}
                    <td>{{ record.hours }}</td>
                    <td>{{ record.minutes }}</td>
                    <td>{{ record.quality|default:"-"|title }}</td>
                  {% elif record_type == 'Diet' %}
                    <td>{{ record.calories }}</td>
                    <td>{{ record.protein|default:"-" }}</td>
                    <td>{{ record.carbs|default:"-" }}</td>
                    <td>{{ record.fat|default:"-" }}</td>
                  {% elif record_type == 'Running' %}
                    <td>{{ record.distance }}</td>
                    <td>{{ record.duration_minutes }}</td>
                    <td>{{ record.calories_burned|default:"-" }}</td>
                  {% elif record_type == 'Mood' %}
                    <td>{{ record.mood|title }}</td>
                    <td>{{ record.stress_level|default:"-" }}</td>
                  {% endif %}
                  <td>
                    {% if record_type == 'Steps' %}
                      <a href="{% url 'steps_edit' record.id %}" class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil"></i></a>
                      <a href="{% url 'steps_delete' record.id %}" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></a>
                    {% elif record_type == 'Sleep' %}
                      <a href="{% url 'sleep_edit' record.id %}" class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil"></i></a>
                      <a href="{% url 'sleep_delete' record.id %}" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></a>
                    {% elif record_type == 'Diet' %}
                      <a href="{% url 'diet_edit' record.id %}" class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil"></i></a>
                      <a href="{% url 'diet_delete' record.id %}" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></a>
                    {% elif record_type == 'Running' %}
                      <a href="{% url 'running_edit' record.id %}" class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil"></i></a>
                      <a href="{% url 'running_delete' record.id %}" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></a>
                    {% elif record_type == 'Training' %}
                      <a href="{% url 'training_edit' record.id %}" class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil"></i></a>
                      <a href="{% url 'training_delete' record.id %}" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></a>
                    {% elif record_type == 'Mood' %}
                      <a href="{% url 'mood_edit' record.id %}" class="btn btn-sm btn-outline-primary"><i class="bi bi-pencil"></i></a>
                      <a href="{% url 'mood_delete' record.id %}" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></a>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-center py-5">
          <div class="mb-4">
            <i class="bi bi-clipboard-data" style="font-size: 3rem; color: #ddd;"></i>
          </div>
          <p class="text-muted">No {{ record_type }} records found</p>
          <div>
            <a href="
            {% if active_tab == 'step' %}{% url 'steps_add' %}
            {% elif active_tab == 'sleep' %}{% url 'sleep_add' %}
            {% elif active_tab == 'diet' %}{% url 'diet_add' %}
            {% elif active_tab == 'running' %}{% url 'running_add' %}
            {% elif active_tab == 'training' %}{% url 'training_add' %}
            {% elif active_tab == 'mood' %}{% url 'mood_add' %}
            {% else %}#{% endif %}" class="btn btn-primary">
              <i class="bi bi-plus-lg me-1"></i> Add Your First {{ record_type }} Record
            </a>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block javascript %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Debug information
  console.log('Chart.js version:', Chart ? Chart.version : 'not loaded');
  
  // Convert Django template variables to JavaScript variables
  var chartDates = {{ chart_dates|safe }};
  var chartValues = {{ chart_data|safe }};
  var recordType = "{{ record_type }}";
  var activeTab = "{{ active_tab }}";
  
  // Debug data
  console.log('Date data:', chartDates);
  console.log('Chart data:', chartValues);
  console.log('Record type:', recordType);
  console.log('Active tab:', activeTab);
  
  // Ensure DOM is fully loaded before rendering chart
  window.addEventListener('DOMContentLoaded', function() {
    // Get chart context
    var ctx = document.getElementById('recordChart').getContext('2d');
    
    // Check if data is valid
    if (!chartDates || !chartValues || chartDates.length === 0 || chartValues.length === 0) {
      console.error('Chart data is empty or invalid');
      // Display a "no data" message
      var noDataMessage = document.createElement('div');
      noDataMessage.textContent = 'No historical data available';
      noDataMessage.style.textAlign = 'center';
      noDataMessage.style.padding = '50px';
      noDataMessage.style.color = '#999';
      document.getElementById('recordChart').parentNode.appendChild(noDataMessage);
      document.getElementById('recordChart').style.display = 'none';
      return;
    }
    
    // Chart color configuration
    var chartColors = {
      step: '#4BC0C0',
      sleep: '#9966FF',
      diet: '#FF9F40',
      running: '#36A2EB',
      training: '#FF7043',
      mood: '#FF6384'
    };
    
    // Get current tab color
    var color = chartColors[activeTab] || '#4BC0C0';
    
    // Chart data configuration
    var chartConfig = {
      labels: chartDates,
      datasets: [{
        label: recordType,
        data: chartValues,
        backgroundColor: color + '33', // with alpha
        borderColor: color,
        borderWidth: 2,
        tension: 0.1,
        fill: true,
        pointRadius: 4,
        pointHoverRadius: 6
      }]
    };
    
    // Chart options configuration
    var options = {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: getYAxisLabel(recordType)
          },
          grid: {
            color: 'rgba(0,0,0,0.05)'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Date'
          },
          grid: {
            color: 'rgba(0,0,0,0.05)'
          }
        }
      },
      animation: {
        duration: 1000,
        easing: 'easeOutQuart'
      },
      plugins: {
        tooltip: {
          mode: 'index',
          intersect: false,
          backgroundColor: 'rgba(0,0,0,0.7)',
          padding: 10,
          titleFont: {
            size: 14
          },
          bodyFont: {
            size: 14
          }
        },
        legend: {
          display: true,
          position: 'top',
          labels: {
            font: {
              size: 14
            },
            padding: 20
          }
        }
      }
    };
    
    // Create chart
    console.log('Starting chart creation, data length:', chartValues.length);
    var myChart = new Chart(ctx, {
      type: activeTab === 'mood' ? 'bar' : 'line',
      data: chartConfig,
      options: options
    });
    console.log('Chart creation complete');
    
    // Add window resize event to ensure chart displays correctly
    window.addEventListener('resize', function() {
      if(myChart.resize) {
        myChart.resize();
      }
    });
    
    // Get Y axis label based on record type
    function getYAxisLabel(recordType) {
      switch(recordType) {
        case 'Steps': return 'Steps Count';
        case 'Sleep': return 'Hours';
        case 'Diet': return 'Calories';
        case 'Running': return 'Distance (km)';
        case 'Mood': return 'Mood Level';
        case 'Training': return 'Training Volume';
        default: return 'Value';
      }
    }
  });
</script>
{% endblock %} 