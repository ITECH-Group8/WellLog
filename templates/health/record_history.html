{% extends 'base_with_sidebar.html' %}
{% load static %}

{% block title %}å¥åº·è®°å½•å†å²{% endblock %}

{% block css %}
{{ block.super }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
<style>
  /* å†å²è®°å½•é¡µé¢ä¼˜åŒ–æ ·å¼ */
  .history-container {
    padding: 1rem;
  }
  
  .history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }
  
  .history-header h2 {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
  }
  
  .history-header h2 i {
    font-size: 1.2rem;
  }
  
  .dashboard-header {
    margin-bottom: 1rem !important;
  }
  
  .nav-tabs .nav-link {
    font-size: 0.9rem;
    padding: 0.5rem 0.8rem;
  }
  
  .nav-tabs .nav-link i {
    font-size: 0.9rem;
  }
  
  .export-btn {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    display: inline-flex;
    align-items: center;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .export-btn:hover {
    background-color: #e9ecef;
  }
  
  .export-btn i {
    margin-right: 0.3rem;
    font-size: 0.8rem;
  }
  
  /* ç»Ÿè®¡å¡ç‰‡ä¼˜åŒ– */
  .summary-stats {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  
  .stat-card {
    background: white;
    border-radius: 0.5rem;
    padding: 0.8rem 1rem;
    flex: 1;
    min-width: 120px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    text-align: center;
    transition: transform 0.2s;
  }
  
  .stat-card:hover {
    transform: translateY(-3px);
  }
  
  .stat-title {
    font-size: 0.8rem;
    color: #6c757d;
    margin-bottom: 0.3rem;
  }
  
  .stat-value {
    font-size: 1.5rem;
    font-weight: 600;
    color: #212529;
  }
  
  /* å›¾è¡¨åŒºåŸŸä¼˜åŒ– - è‡ªé€‚åº”å°ºå¯¸ */
  .chart-container {
    background: white;
    border-radius: 0.5rem;
    padding: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    width: 100%;
    margin: 0 auto 1.5rem auto;
  }
  
  /* å›¾è¡¨åŒ…è£…å®¹å™¨ */
  .chart-wrapper {
    position: relative;
    width: 100%;
    height: auto;
    min-height: 250px;
    max-height: 450px;
  }
  
  .chart-types {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }
  
  .chart-type-btn {
    padding: 0.3rem 0.6rem;
    font-size: 0.8rem;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .chart-type-btn.active {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
  }
  
  /* è¿‡æ»¤å™¨å¡ç‰‡ */
  .filter-card {
    background: white;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }
  
  .filter-buttons {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
    flex-wrap: wrap;
  }
  
  /* æ•°æ®è¡¨ä¼˜åŒ– */
  .history-card {
    background: white;
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }
  
  .history-card .card-header {
    padding: 0.75rem 1rem;
    background-color: #f8f9fa;
    border-bottom: 1px solid rgba(0,0,0,0.05);
  }
  
  .history-card .card-header h5 {
    font-size: 1rem;
    margin: 0;
  }
  
  .history-table {
    width: 100%;
    border-collapse: collapse;
  }
  
  .history-table th,
  .history-table td {
    padding: 0.6rem 0.8rem;
    border-bottom: 1px solid #e9ecef;
  }
  
  .history-table th {
    background-color: #f8f9fa;
    font-weight: 500;
    text-align: left;
  }
  
  .action-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: 0.25rem;
    margin-right: 0.3rem;
    transition: all 0.2s;
  }
  
  .action-btn.edit {
    background-color: #e9ecef;
    color: #495057;
  }
  
  .action-btn.delete {
    background-color: #f8d7da;
    color: #dc3545;
  }
  
  .action-btn:hover {
    opacity: 0.8;
  }
  
  /* ç©ºçŠ¶æ€ä¼˜åŒ– */
  .empty-state {
    text-align: center;
    padding: 2rem 1rem;
  }
  
  .empty-state i {
    font-size: 2rem;
    color: #adb5bd;
    margin-bottom: 1rem;
  }
  
  /* åˆ†é¡µä¼˜åŒ– */
  .pagination {
    margin-top: 1rem;
    justify-content: center;
  }
  
  /* å“åº”å¼è°ƒæ•´ */
  @media (max-width: 576px) {
    .chart-wrapper {
      min-height: 200px;
    }
    
    .history-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.5rem;
    }
    
    .chart-type-btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
    }
    
    .stat-card {
      min-width: 100px;
      padding: 0.6rem 0.8rem;
    }
    
    .stat-value {
      font-size: 1.25rem;
    }
  }
  
  @media (min-width: 577px) and (max-width: 991px) {
    .chart-wrapper {
      min-height: 300px;
    }
  }
  
  @media (min-width: 992px) {
    .chart-wrapper {
      min-height: 400px;
    }
  }
</style>
{% endblock %}

{% block content %}
<!-- å¥åº·è®°å½•å†å²å†…å®¹ -->
<div class="container-fluid py-4">
  <div class="history-container animate__animated animate__fadeIn">
    <div class="history-header">
      <h2>
        {% if record_type == 'Steps' %}
          <i class="bi bi-activity me-2"></i>
        {% elif record_type == 'Sleep' %}
          <i class="bi bi-moon me-2"></i>
        {% elif record_type == 'Diet' %}
          <i class="bi bi-egg-fried me-2"></i>
        {% elif record_type == 'Running' %}
          <i class="bi bi-lightning me-2"></i>
        {% elif record_type == 'Training' %}
          <i class="bi bi-trophy me-2"></i>
        {% elif record_type == 'Mood' %}
          <i class="bi bi-emoji-smile me-2"></i>
        {% elif record_type == 'Weight' %}
          <i class="bi bi-person-fill me-2"></i>
        {% endif %}
        {{ record_type }} è®°å½•å†å²
      </h2>
      <div>
        <button class="export-btn">
          <i class="bi bi-download"></i>å¯¼å‡ºæ•°æ®
        </button>
      </div>
    </div>
    
    <!-- æ·»åŠ å¯¼èˆªæ ‡ç­¾ -->
    <div class="dashboard-header d-flex justify-content-between align-items-center mb-4">
      <ul class="nav nav-tabs" id="healthTabs">
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'overall' %}active{% endif %}" href="{% url 'dashboard' %}">
            <i class="bi bi-grid-3x3-gap me-1"></i>Overview
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'running' %}active{% endif %}" href="{% url 'running_history' %}">
            <i class="bi bi-lightning me-1"></i>Running
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'step' %}active{% endif %}" href="{% url 'steps_history' %}">
            <i class="bi bi-activity me-1"></i>Steps
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'training' %}active{% endif %}" href="{% url 'training_history' %}">
            <i class="bi bi-trophy me-1"></i>Training
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'sleep' %}active{% endif %}" href="{% url 'sleep_history' %}">
            <i class="bi bi-moon me-1"></i>Sleep
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'diet' %}active{% endif %}" href="{% url 'diet_history' %}">
            <i class="bi bi-egg-fried me-1"></i>Diet
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'mood' %}active{% endif %}" href="{% url 'mood_history' %}">
            <i class="bi bi-emoji-smile me-1"></i>Mood
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if active_tab == 'weight' %}active{% endif %}" href="{% url 'weight_history' %}">
            <i class="bi bi-person-fill me-1"></i>Weight
          </a>
        </li>
      </ul>
      <div>
        {% if record_type == 'Steps' %}
          <a href="{% url 'steps_add' %}" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-circle me-1"></i> æ·»åŠ æ­¥æ•°è®°å½•
          </a>
        {% elif record_type == 'Sleep' %}
          <a href="{% url 'sleep_add' %}" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-circle me-1"></i> æ·»åŠ ç¡çœ è®°å½•
          </a>
        {% elif record_type == 'Diet' %}
          <a href="{% url 'diet_add' %}" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-circle me-1"></i> æ·»åŠ é¥®é£Ÿè®°å½•
          </a>
        {% elif record_type == 'Running' %}
          <a href="{% url 'running_add' %}" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-circle me-1"></i> æ·»åŠ è·‘æ­¥è®°å½•
          </a>
        {% elif record_type == 'Mood' %}
          <a href="{% url 'mood_add' %}" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-circle me-1"></i> æ·»åŠ å¿ƒæƒ…è®°å½•
          </a>
        {% elif record_type == 'Weight' %}
          <a href="{% url 'weight_add' %}" class="btn btn-primary btn-sm">
            <i class="bi bi-plus-circle me-1"></i> æ·»åŠ ä½“é‡è®°å½•
          </a>
        {% endif %}
      </div>
    </div>
    
    <!-- ç»Ÿè®¡æ‘˜è¦ -->
    <div class="summary-stats">
      <div class="stat-card animate__animated animate__fadeInUp" style="animation-delay: 0.1s;">
        <div class="stat-title">è®°å½•æ€»æ•°</div>
        <div class="stat-value">{{ records|length }}</div>
      </div>
      
      {% if record_type == 'Steps' %}
      <div class="stat-card animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
        <div class="stat-title">å¹³å‡æ­¥æ•°</div>
        <div class="stat-value">{{ avg_steps|default:"0" }}</div>
      </div>
      <div class="stat-card animate__animated animate__fadeInUp" style="animation-delay: 0.3s;">
        <div class="stat-title">æœ€é«˜æ­¥æ•°</div>
        <div class="stat-value">{{ max_steps|default:"0" }}</div>
      </div>
      {% elif record_type == 'Sleep' %}
      <div class="stat-card animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
        <div class="stat-title">å¹³å‡ç¡çœ æ—¶é•¿</div>
        <div class="stat-value">{{ avg_sleep|default:"0" }}h</div>
      </div>
      <div class="stat-card animate__animated animate__fadeInUp" style="animation-delay: 0.3s;">
        <div class="stat-title">å¹³å‡ç¡çœ è´¨é‡</div>
        <div class="stat-value">{{ avg_quality|default:"è‰¯å¥½" }}</div>
      </div>
      {% elif record_type == 'Diet' %}
      <div class="stat-card animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
        <div class="stat-title">å¹³å‡å¡è·¯é‡Œ</div>
        <div class="stat-value">{{ avg_calories|default:"0" }}</div>
      </div>
      <div class="stat-card animate__animated animate__fadeInUp" style="animation-delay: 0.3s;">
        <div class="stat-title">å¹³å‡è›‹ç™½è´¨</div>
        <div class="stat-value">{{ avg_protein|default:"0" }}g</div>
      </div>
      {% elif record_type == 'Running' %}
      <div class="stat-card animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
        <div class="stat-title">æ€»è·ç¦»</div>
        <div class="stat-value">{{ total_distance|default:"0" }}km</div>
      </div>
      <div class="stat-card animate__animated animate__fadeInUp" style="animation-delay: 0.3s;">
        <div class="stat-title">å¹³å‡é…é€Ÿ</div>
        <div class="stat-value">{{ avg_pace|default:"0" }}åˆ†/km</div>
      </div>
      {% elif record_type == 'Weight' %}
      <div class="stat-card animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
        <div class="stat-title">å¹³å‡ä½“é‡</div>
        <div class="stat-value">{{ avg_weight|default:"0" }}kg</div>
      </div>
      <div class="stat-card animate__animated animate__fadeInUp" style="animation-delay: 0.3s;">
        <div class="stat-title">å¹³å‡BMI</div>
        <div class="stat-value">{{ avg_bmi|default:"0" }}</div>
      </div>
      {% endif %}
    </div>
    
    <!-- å›¾è¡¨åŒºåŸŸ - è‡ªé€‚åº”å°ºå¯¸ -->
    <div class="chart-container mb-4 animate__animated animate__fadeInUp" style="animation-delay: 0.4s;">
      <div class="chart-types">
        <button class="chart-type-btn {% if chart_type == 'line' or not chart_type %}active{% endif %}" data-chart-type="line">æŠ˜çº¿å›¾</button>
        <button class="chart-type-btn {% if chart_type == 'bar' %}active{% endif %}" data-chart-type="bar">æŸ±çŠ¶å›¾</button>
        <button class="chart-type-btn {% if chart_type == 'pie' %}active{% endif %}" data-chart-type="pie">é¥¼å›¾</button>
      </div>
      <div class="chart-wrapper">
        <canvas id="recordChart"></canvas>
      </div>
    </div>
    
    <!-- è¿‡æ»¤å™¨ - é»˜è®¤æ˜¾ç¤ºå½“å‰æ•°æ®èŒƒå›´ -->
    <div class="filter-card animate__animated animate__fadeInUp" style="animation-delay: 0.5s;">
      <form method="get" action="" id="dateFilterForm">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="date_from" class="form-label">å¼€å§‹æ—¥æœŸ</label>
              <input type="date" class="form-control" id="date_from" name="date_from" 
                     value="{{ date_from|default:'' }}">
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label for="date_to" class="form-label">ç»“æŸæ—¥æœŸ</label>
              <input type="date" class="form-control" id="date_to" name="date_to" 
                     value="{{ date_to|default:'' }}">
            </div>
          </div>
        </div>
        <!-- æ·»åŠ ä¸€ä¸ªéšè—çš„è¾“å…¥æ¡†æ¥ä¿å­˜å½“å‰çš„å›¾è¡¨ç±»å‹ -->
        <input type="hidden" name="chart_type" id="chartTypeInput" value="{{ chart_type|default:'line' }}">
        <p class="text-muted small mb-2"><i class="bi bi-info-circle me-1"></i>å¦‚æœæœªè®¾ç½®æ—¥æœŸï¼Œå°†è‡ªåŠ¨ä½¿ç”¨ç°æœ‰è®°å½•çš„æ—¥æœŸèŒƒå›´</p>
        <div class="filter-buttons">
          <button type="submit" class="btn btn-primary btn-sm">
            <i class="bi bi-filter me-1"></i>è¿‡æ»¤
          </button>
          {% if record_type == 'Steps' %}
            <a href="{% url 'steps_history' %}" class="btn btn-outline-secondary btn-sm" id="resetButton">
              <i class="bi bi-x-circle me-1"></i>é‡ç½®
            </a>
          {% elif record_type == 'Sleep' %}
            <a href="{% url 'sleep_history' %}" class="btn btn-outline-secondary btn-sm" id="resetButton">
              <i class="bi bi-x-circle me-1"></i>é‡ç½®
            </a>
          {% elif record_type == 'Diet' %}
            <a href="{% url 'diet_history' %}" class="btn btn-outline-secondary btn-sm" id="resetButton">
              <i class="bi bi-x-circle me-1"></i>é‡ç½®
            </a>
          {% elif record_type == 'Running' %}
            <a href="{% url 'running_history' %}" class="btn btn-outline-secondary btn-sm" id="resetButton">
              <i class="bi bi-x-circle me-1"></i>é‡ç½®
            </a>
          {% elif record_type == 'Mood' %}
            <a href="{% url 'mood_history' %}" class="btn btn-outline-secondary btn-sm" id="resetButton">
              <i class="bi bi-x-circle me-1"></i>é‡ç½®
            </a>
          {% elif record_type == 'Weight' %}
            <a href="{% url 'weight_history' %}" class="btn btn-outline-secondary btn-sm" id="resetButton">
              <i class="bi bi-x-circle me-1"></i>é‡ç½®
            </a>
          {% endif %}
        </div>
      </form>
    </div>
    
    <!-- æ•°æ®è®°å½•è¡¨ -->
    <div class="history-card animate__animated animate__fadeInUp" style="animation-delay: 0.6s;">
      <div class="card-header">
        <h5>{{ record_type }} è®°å½•åˆ—è¡¨</h5>
      </div>
      <div class="card-body">
        {% if records %}
          <div class="table-responsive">
            <table class="history-table">
              <thead>
                <tr>
                  <th>æ—¥æœŸ</th>
                  {% if record_type == 'Steps' %}
                    <th>æ­¥æ•°</th>
                  {% elif record_type == 'Sleep' %}
                    <th>å°æ—¶</th>
                    <th>åˆ†é’Ÿ</th>
                    <th>è´¨é‡</th>
                  {% elif record_type == 'Diet' %}
                    <th>å¡è·¯é‡Œ</th>
                    <th>è›‹ç™½è´¨ (g)</th>
                    <th>ç¢³æ°´ (g)</th>
                    <th>è„‚è‚ª (g)</th>
                  {% elif record_type == 'Running' %}
                    <th>è·ç¦» (km)</th>
                    <th>æ—¶é•¿ (åˆ†é’Ÿ)</th>
                    <th>æ¶ˆè€—å¡è·¯é‡Œ</th>
                  {% elif record_type == 'Mood' %}
                    <th>å¿ƒæƒ…</th>
                    <th>å‹åŠ›æ°´å¹³</th>
                  {% elif record_type == 'Weight' %}
                    <th>ä½“é‡ (kg)</th>
                    <th>BMI</th>
                  {% endif %}
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody>
                {% for record in records %}
                  <tr class="animate__animated animate__fadeIn" style="animation-delay: {{ forloop.counter0|floatformat:1 }}0ms">
                    <td>{{ record.date|date:"Y-m-d" }}</td>
                    {% if record_type == 'Steps' %}
                      <td>{{ record.steps_count }}</td>
                    {% elif record_type == 'Sleep' %}
                      <td>{{ record.hours }}</td>
                      <td>{{ record.minutes }}</td>
                      <td>{{ record.quality|default:"æœªæŒ‡å®š" }}</td>
                    {% elif record_type == 'Diet' %}
                      <td>{{ record.calories }}</td>
                      <td>{{ record.protein }}</td>
                      <td>{{ record.carbs }}</td>
                      <td>{{ record.fat }}</td>
                    {% elif record_type == 'Running' %}
                      <td>{{ record.distance }}</td>
                      <td>{{ record.duration }}</td>
                      <td>{{ record.calories_burned }}</td>
                    {% elif record_type == 'Mood' %}
                      <td>
                        {% if record.mood == 'excellent' %}ğŸ˜ æå¥½
                        {% elif record.mood == 'good' %}ğŸ˜Š è‰¯å¥½
                        {% elif record.mood == 'neutral' %}ğŸ˜ ä¸€èˆ¬
                        {% elif record.mood == 'bad' %}ğŸ˜” ä¸ä½³
                        {% elif record.mood == 'terrible' %}ğŸ˜¢ ç³Ÿç³•
                        {% endif %}
                      </td>
                      <td>{{ record.stress_level|default:"æœªæŒ‡å®š" }}</td>
                    {% elif record_type == 'Weight' %}
                      <td>{{ record.weight }}</td>
                      <td>{{ record.bmi }}</td>
                    {% endif %}
                    <td>
                      {% if record_type == 'Steps' %}
                        <a href="{% url 'steps_edit' record.id %}" class="action-btn edit">
                          <i class="bi bi-pencil"></i>
                        </a>
                        <a href="{% url 'steps_delete' record.id %}" class="action-btn delete">
                          <i class="bi bi-trash"></i>
                        </a>
                      {% elif record_type == 'Sleep' %}
                        <a href="{% url 'sleep_edit' record.id %}" class="action-btn edit">
                          <i class="bi bi-pencil"></i>
                        </a>
                        <a href="{% url 'sleep_delete' record.id %}" class="action-btn delete">
                          <i class="bi bi-trash"></i>
                        </a>
                      {% elif record_type == 'Diet' %}
                        <a href="{% url 'diet_edit' record.id %}" class="action-btn edit">
                          <i class="bi bi-pencil"></i>
                        </a>
                        <a href="{% url 'diet_delete' record.id %}" class="action-btn delete">
                          <i class="bi bi-trash"></i>
                        </a>
                      {% elif record_type == 'Running' %}
                        <a href="{% url 'running_edit' record.id %}" class="action-btn edit">
                          <i class="bi bi-pencil"></i>
                        </a>
                        <a href="{% url 'running_delete' record.id %}" class="action-btn delete">
                          <i class="bi bi-trash"></i>
                        </a>
                      {% elif record_type == 'Mood' %}
                        <a href="{% url 'mood_edit' record.id %}" class="action-btn edit">
                          <i class="bi bi-pencil"></i>
                        </a>
                        <a href="{% url 'mood_delete' record.id %}" class="action-btn delete">
                          <i class="bi bi-trash"></i>
                        </a>
                      {% elif record_type == 'Weight' %}
                        <a href="{% url 'weight_edit' record.id %}" class="action-btn edit">
                          <i class="bi bi-pencil"></i>
                        </a>
                        <a href="{% url 'weight_delete' record.id %}" class="action-btn delete">
                          <i class="bi bi-trash"></i>
                        </a>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          
          <!-- åˆ†é¡µ -->
          {% if is_paginated %}
            <nav aria-label="Page navigation">
              <ul class="pagination">
                {% if page_obj.has_previous %}
                  <li class="page-item">
                    <a class="page-link" href="?page=1{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if chart_type %}&chart_type={{ chart_type }}{% endif %}" aria-label="First">
                      <span aria-hidden="true">&laquo;&laquo;</span>
                    </a>
                  </li>
                  <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if chart_type %}&chart_type={{ chart_type }}{% endif %}" aria-label="Previous">
                      <span aria-hidden="true">&laquo;</span>
                    </a>
                  </li>
                {% endif %}
                
                {% for num in page_obj.paginator.page_range %}
                  {% if page_obj.number == num %}
                    <li class="page-item active">
                      <span class="page-link">{{ num }}</span>
                    </li>
                  {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item">
                      <a class="page-link" href="?page={{ num }}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if chart_type %}&chart_type={{ chart_type }}{% endif %}">{{ num }}</a>
                    </li>
                  {% endif %}
                {% endfor %}
                
                {% if page_obj.has_next %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if chart_type %}&chart_type={{ chart_type }}{% endif %}" aria-label="Next">
                      <span aria-hidden="true">&raquo;</span>
                    </a>
                  </li>
                  <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}{% if chart_type %}&chart_type={{ chart_type }}{% endif %}" aria-label="Last">
                      <span aria-hidden="true">&raquo;&raquo;</span>
                    </a>
                  </li>
                {% endif %}
              </ul>
            </nav>
          {% endif %}
        {% else %}
          <div class="empty-state">
            <i class="bi bi-clipboard-x"></i>
            <h5>æš‚æ— è®°å½•</h5>
            <p>æ‚¨è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•{{ record_type }}è®°å½•</p>
            {% if record_type == 'Steps' %}
              <a href="{% url 'steps_add' %}" class="btn btn-outline-success btn-sm mt-3">
                <i class="bi bi-plus-lg"></i> æ·»åŠ æ­¥æ•°è®°å½•
              </a>
            {% elif record_type == 'Sleep' %}
              <a href="{% url 'sleep_add' %}" class="btn btn-outline-success btn-sm mt-3">
                <i class="bi bi-plus-lg"></i> æ·»åŠ ç¡çœ è®°å½•
              </a>
            {% elif record_type == 'Diet' %}
              <a href="{% url 'diet_add' %}" class="btn btn-outline-success btn-sm mt-3">
                <i class="bi bi-plus-lg"></i> æ·»åŠ é¥®é£Ÿè®°å½•
              </a>
            {% elif record_type == 'Running' %}
              <a href="{% url 'running_add' %}" class="btn btn-outline-success btn-sm mt-3">
                <i class="bi bi-plus-lg"></i> æ·»åŠ è·‘æ­¥è®°å½•
              </a>
            {% elif record_type == 'Mood' %}
              <a href="{% url 'mood_add' %}" class="btn btn-outline-success btn-sm mt-3">
                <i class="bi bi-plus-lg"></i> æ·»åŠ å¿ƒæƒ…è®°å½•
              </a>
            {% elif record_type == 'Weight' %}
              <a href="{% url 'weight_add' %}" class="btn btn-outline-success btn-sm mt-3">
                <i class="bi bi-plus-lg"></i> æ·»åŠ ä½“é‡è®°å½•
              </a>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block javascript %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // è·å–å½“å‰URLä¸­çš„chart_typeå‚æ•°ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä¸º'line'
    const params = new URLSearchParams(window.location.search);
    const chartType = params.get('chart_type') || 'line';
    
    // åˆå§‹åŒ–å›¾è¡¨
    initCharts(chartType);
    
    // å›¾è¡¨ç±»å‹åˆ‡æ¢
    document.querySelectorAll('.chart-type-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.chart-type-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        // æ›´æ–°éšè—è¾“å…¥æ¡†çš„å€¼ï¼Œç¡®ä¿æäº¤è¡¨å•æ—¶åŒ…å«å½“å‰å›¾è¡¨ç±»å‹
        document.getElementById('chartTypeInput').value = this.dataset.chartType;
        
        initCharts(this.dataset.chartType);
      });
    });
    
    // ç¡®ä¿å¯¼èˆªé“¾æ¥ç›´æ¥è·³è½¬ï¼Œä¸è¢«ä»»ä½•äº‹ä»¶é˜»æ­¢
    document.querySelectorAll('#healthTabs .nav-link').forEach(link => {
      // ä½¿ç”¨å…‹éš†èŠ‚ç‚¹æ¥åˆ é™¤æ‰€æœ‰å¯èƒ½çš„äº‹ä»¶ç›‘å¬å™¨
      const newLink = link.cloneNode(true);
      if (link.parentNode) {
        link.parentNode.replaceChild(newLink, link);
      }
    });
    
    // ç¡®ä¿é‡ç½®æŒ‰é’®ä¹Ÿä¸è¢«äº‹ä»¶é˜»æ­¢
    const resetButton = document.getElementById('resetButton');
    if (resetButton) {
      const newResetButton = resetButton.cloneNode(true);
      if (resetButton.parentNode) {
        resetButton.parentNode.replaceChild(newResetButton, resetButton);
      }
      
      // ç‚¹å‡»é‡ç½®æŒ‰é’®æ—¶ï¼Œç¡®ä¿å®Œå…¨é‡ç½®æ‰€æœ‰è¿‡æ»¤å‚æ•°
      newResetButton.addEventListener('click', function(e) {
        e.preventDefault();
        
        // æ¸…ç©ºè¡¨å•è¾“å…¥æ¡†
        document.getElementById('date_from').value = '';
        document.getElementById('date_to').value = '';
        document.getElementById('chartTypeInput').value = 'line';
        
        // ç›´æ¥è·³è½¬åˆ°ä¸å¸¦å‚æ•°çš„URL
        window.location.href = this.getAttribute('href');
      });
    }
    
    // åˆå§‹åŒ–æ—¥æœŸè¿‡æ»¤å™¨å¹¶ç«‹å³è®¾ç½®å€¼
    initDateFilters();
    
    // ä¼˜åŒ–æ—¥æœŸè¿‡æ»¤å™¨æäº¤
    document.getElementById('dateFilterForm').addEventListener('submit', function(e) {
      // ä¸å†é˜»æ­¢é»˜è®¤æäº¤ï¼Œä½¿ç”¨è¡¨å•åŸç”Ÿæäº¤
      // e.preventDefault(); 
      
      const dateFrom = document.getElementById('date_from');
      const dateTo = document.getElementById('date_to');
      
      // ç¡®ä¿æ—¥æœŸæœ‰æ•ˆ
      if (dateFrom.value && dateTo.value) {
        const fromDate = new Date(dateFrom.value);
        const toDate = new Date(dateTo.value);
        
        if (fromDate > toDate) {
          e.preventDefault();
          alert('å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ');
          return false;
        }
      }
      
      // ä½¿ç”¨è¡¨å•åŸç”Ÿæäº¤æ–¹å¼ï¼Œä¸å†æ‰‹åŠ¨æ„å»ºURL
      return true;
    });
  });
  
  // åˆå§‹åŒ–æ—¥æœŸè¿‡æ»¤å™¨
  function initDateFilters() {
    {% if chart_dates %}
      const chartDates = {{ chart_dates|safe }};
      if (chartDates && chartDates.length > 0) {
        const dateFrom = document.getElementById('date_from');
        const dateTo = document.getElementById('date_to');
        
        // ç¡®ä¿å§‹ç»ˆè®¾ç½®æœ‰æ•ˆçš„é»˜è®¤æ—¥æœŸèŒƒå›´
        if (!dateFrom.value && chartDates.length > 0) {
          dateFrom.value = chartDates[0];
          console.log('è®¾ç½®å¼€å§‹æ—¥æœŸ:', dateFrom.value);
        }
        
        if (!dateTo.value && chartDates.length > 0) {
          dateTo.value = chartDates[chartDates.length - 1];
          console.log('è®¾ç½®ç»“æŸæ—¥æœŸ:', dateTo.value);
        }
      }
    {% else %}
      console.log('æ²¡æœ‰å¯ç”¨çš„æ—¥æœŸæ•°æ®è®¾ç½®é»˜è®¤è¿‡æ»¤èŒƒå›´');
    {% endif %}
    
    // è·å–URLå‚æ•°ä¸­çš„æ—¥æœŸå€¼å¹¶è®¾ç½®åˆ°è¡¨å•ä¸­
    const urlParams = new URLSearchParams(window.location.search);
    const fromParam = urlParams.get('date_from');
    const toParam = urlParams.get('date_to');
    
    if (fromParam) {
      document.getElementById('date_from').value = fromParam;
      console.log('ä»URLè®¾ç½®å¼€å§‹æ—¥æœŸ:', fromParam);
    }
    
    if (toParam) {
      document.getElementById('date_to').value = toParam;
      console.log('ä»URLè®¾ç½®ç»“æŸæ—¥æœŸ:', toParam);
    }
  }
  
  // åˆå§‹åŒ–å›¾è¡¨
  function initCharts(type) {
    const ctx = document.getElementById('recordChart').getContext('2d');
    let chartData = {};
    let chartOptions = {};
    
    {% if chart_dates and chart_data %}
      const chartDates = {{ chart_dates|safe }};
      const chartValues = {{ chart_data|safe }};
      
      // ä¸ºä½“é‡å›¾è¡¨è®¡ç®—åˆé€‚çš„åæ ‡èŒƒå›´
      {% if record_type == 'Weight' %}
      const bmiValues = {{ chart_bmi_data|safe }};
      const [weightMin, weightMax] = calculateAxisRange(chartValues);
      const [bmiMin, bmiMax] = calculateAxisRange(bmiValues);
      {% endif %}
      
      {% if record_type == 'Steps' %}
        chartData = {
          labels: chartDates,
          datasets: [{
            label: 'æ­¥æ•°',
            data: chartValues,
            backgroundColor: 'rgba(40, 167, 69, 0.7)',
            borderColor: 'rgba(40, 167, 69, 1)',
            borderWidth: 1,
            tension: 0.3,
            fill: type === 'line'
          }]
        };
      {% elif record_type == 'Sleep' %}
        chartData = {
          labels: chartDates,
          datasets: [{
            label: 'ç¡çœ æ—¶é•¿ (å°æ—¶)',
            data: chartValues,
            backgroundColor: 'rgba(111, 66, 193, 0.7)',
            borderColor: 'rgba(111, 66, 193, 1)',
            borderWidth: 1,
            tension: 0.3,
            fill: type === 'line'
          }]
        };
      {% elif record_type == 'Diet' %}
        chartData = {
          labels: chartDates,
          datasets: [{
            label: 'å¡è·¯é‡Œ',
            data: chartValues,
            backgroundColor: 'rgba(220, 53, 69, 0.7)',
            borderColor: 'rgba(220, 53, 69, 1)',
            borderWidth: 1,
            tension: 0.3,
            fill: type === 'line'
          }]
        };
      {% elif record_type == 'Running' %}
        chartData = {
          labels: chartDates,
          datasets: [{
            label: 'è·ç¦» (km)',
            data: chartValues,
            backgroundColor: 'rgba(13, 110, 253, 0.7)',
            borderColor: 'rgba(13, 110, 253, 1)',
            borderWidth: 1,
            tension: 0.3,
            fill: type === 'line'
          }]
        };
      {% elif record_type == 'Mood' %}
        chartData = {
          labels: chartDates,
          datasets: [{
            label: 'å¿ƒæƒ…æ°´å¹³',
            data: chartValues,
            backgroundColor: 'rgba(255, 193, 7, 0.7)',
            borderColor: 'rgba(255, 193, 7, 1)',
            borderWidth: 1,
            tension: 0.3,
            fill: type === 'line'
          }]
        };
      {% elif record_type == 'Weight' %}
        chartData = {
          labels: chartDates,
          datasets: [
            {
              label: 'Weight (kg)',
              data: chartValues,
              backgroundColor: 'rgba(54, 162, 235, 0.2)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 2,
              tension: 0.3,
              pointRadius: 4,
              yAxisID: 'y'
            },
            {
              label: 'BMI',
              data: {{ chart_bmi_data|safe }},
              backgroundColor: 'rgba(255, 99, 132, 0.2)',
              borderColor: 'rgba(255, 99, 132, 1)',
              borderWidth: 2,
              tension: 0.3,
              pointRadius: 4,
              yAxisID: 'y1'
            }
          ]
        };
        
        // ä¸ºä½“é‡å›¾è¡¨è®¾ç½®ç‰¹æ®Šçš„é…ç½®
        chartOptions = {
          scales: {
            y: {
              beginAtZero: false,
              min: weightMin,
              max: weightMax,
              ticks: {
                font: { size: 11 }
              },
              title: {
                display: true,
                text: 'Weight (kg)'
              }
            },
            y1: {
              beginAtZero: false,
              min: bmiMin,
              max: bmiMax,
              position: 'right',
              grid: {
                drawOnChartArea: false
              },
              ticks: {
                font: { size: 11 }
              },
              title: {
                display: true,
                text: 'BMI'
              }
            },
            x: {
              ticks: {
                font: { size: 11 },
                maxRotation: 45,
                minRotation: 0
              },
              grid: { display: false }
            }
          }
        };
      {% endif %}
    {% else %}
      // æ²¡æœ‰æ•°æ®æ—¶çš„ç©ºå›¾è¡¨
      chartData = {
        labels: [],
        datasets: [{
          label: 'æ— æ•°æ®',
          data: [],
          backgroundColor: 'rgba(108, 117, 125, 0.7)',
          borderColor: 'rgba(108, 117, 125, 1)',
        }]
      };
    {% endif %}
    
    // é”€æ¯æ—§å›¾è¡¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if (window.recordChart instanceof Chart) {
      window.recordChart.destroy();
    }
    
    // åˆ›å»ºæ–°å›¾è¡¨ - å®Œå…¨è‡ªé€‚åº”
    window.recordChart = new Chart(ctx, {
      type: type,
      data: chartData,
      options: Object.assign({
        responsive: true,
        maintainAspectRatio: false,
        animation: {
          duration: 800,
          easing: 'easeOutQuart'
        },
        plugins: {
          legend: {
            position: 'top',
            labels: {
              boxWidth: 12,
              padding: 8,
              font: {
                size: 12
              }
            }
          },
          title: {
            display: true,
            text: '{{ record_type }} å†å²è¶‹åŠ¿',
            font: {
              size: 14
            },
            padding: {
              top: 10,
              bottom: 10
            }
          },
          tooltip: {
            titleFont: {
              size: 13
            },
            bodyFont: {
              size: 12
            },
            padding: 10
          }
        },
        scales: {
          y: {
            {% if record_type != 'Weight' %}
            beginAtZero: true,
            {% endif %}
            ticks: {
              font: {
                size: 11
              }
            },
            grid: {
              display: true,
              color: 'rgba(0, 0, 0, 0.05)'
            }
          },
          x: {
            ticks: {
              font: {
                size: 11
              },
              maxRotation: 45,
              minRotation: 0
            },
            grid: {
              display: false
            }
          }
        },
        layout: {
          padding: {
            left: 10,
            right: 10,
            top: 10,
            bottom: 10
          }
        }
      }, chartOptions)
    });
  }
  
  /**
   * è®¡ç®—åˆé€‚çš„åæ ‡è½´èŒƒå›´ï¼Œä½¿å›¾è¡¨èƒ½æ›´å¥½åœ°æ˜¾ç¤ºæ•°æ®å˜åŒ–
   * @param {Array} values - æ•°æ®å€¼æ•°ç»„
   * @return {Array} - [min, max] æœ€å°å€¼å’Œæœ€å¤§å€¼
   */
  function calculateAxisRange(values) {
    if (!values || values.length === 0) {
      return [0, 100]; // é»˜è®¤èŒƒå›´
    }
    
    // æ‰¾å‡ºæ•°æ®çš„æœ€å°å€¼å’Œæœ€å¤§å€¼
    const min = Math.min(...values);
    const max = Math.max(...values);
    
    // è®¡ç®—æ•°æ®èŒƒå›´
    const range = max - min;
    
    // å¦‚æœèŒƒå›´éå¸¸å°ï¼Œæˆ‘ä»¬æ‰©å¤§ä¸€ç‚¹ä»¥ä¾¿æ›´å¥½åœ°å¯è§†åŒ–
    if (range < 0.5) {
      // éå¸¸å°çš„å˜åŒ–ï¼Œæ‰©å¤§è§†å›¾èŒƒå›´
      return [min - 0.5, max + 0.5];
    } else if (range < 2) {
      // å°èŒƒå›´å˜åŒ–
      return [min - 0.2 * range, max + 0.2 * range];
    } else if (range < 5) {
      // ä¸­ç­‰èŒƒå›´å˜åŒ–
      return [min - 0.1 * range, max + 0.1 * range];
    } else {
      // å¤§èŒƒå›´å˜åŒ–
      return [min - 0.05 * range, max + 0.05 * range];
    }
  }
</script>
{% endblock %} 