{% extends 'base_with_sidebar.html' %}
{% load static %}
{% load mathfilters %}

{% block title %}Health Dashboard{% endblock %}

{% block css %}
{{ block.super }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
<style>
  /* Health Data Card Styles */
  .health-card {
    transition: all 0.3s;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    height: 100%;
  }
  
  .health-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  }
  
  .health-card .card-header {
    background-color: #f8f9fa;
    font-weight: bold;
    border-bottom: 1px solid rgba(0,0,0,0.05);
  }
  
  .health-card .display-4 {
    font-weight: 600;
    margin: 10px 0;
  }
  
  /* Tab Styles */
  .nav-tabs .nav-link {
    font-size: 0.9rem;
    padding: 0.5rem 0.8rem;
    border-radius: 5px 5px 0 0;
    font-weight: 500;
  }
  
  .nav-tabs .nav-link i {
    font-size: 0.9rem;
  }
  
  .nav-tabs .nav-link.active {
    background-color: #f8f9fa;
    border-bottom-color: #f8f9fa;
  }
  
  .dashboard-header {
    margin-bottom: 1rem !important;
  }
  
  /* Progress Bar Width Classes */
  .progress-width-0 { width: 0%; }
  .progress-width-10 { width: 10%; }
  .progress-width-20 { width: 20%; }
  .progress-width-30 { width: 30%; }
  .progress-width-40 { width: 40%; }
  .progress-width-50 { width: 50%; }
  .progress-width-60 { width: 60%; }
  .progress-width-70 { width: 70%; }
  .progress-width-80 { width: 80%; }
  .progress-width-90 { width: 90%; }
  .progress-width-100 { width: 100%; }
</style>
{% endblock %}

{% block content %}
<!-- Health Dashboard Content -->
<div class="container-fluid py-4">
  <div class="dashboard-container">
    <div class="dashboard-header">
      <h2>
        Health Dashboard
      </h2>
    </div>
    
    <!-- Navigation Tabs -->
    <div class="dashboard-header d-flex justify-content-between align-items-center mb-4">
      <ul class="nav nav-tabs" id="healthTabs">
        <li class="nav-item">
          <a class="nav-link active" href="{% url 'dashboard' %}">
            <i class="bi bi-grid-3x3-gap me-1"></i>Overall
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'running_history' %}">
            <i class="bi bi-lightning me-1"></i>Running
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'steps_history' %}">
            <i class="bi bi-activity me-1"></i>Steps
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'training_history' %}">
            <i class="bi bi-trophy me-1"></i>Training
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'sleep_history' %}">
            <i class="bi bi-moon me-1"></i>Sleep
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'diet_history' %}">
            <i class="bi bi-egg-fried me-1"></i>Diet
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'mood_history' %}">
            <i class="bi bi-emoji-smile me-1"></i>Mood
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{% url 'weight_history' %}">
            <i class="bi bi-clipboard-data me-1"></i>Weight
          </a>
        </li>
      </ul>
      <div>
        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addDataModal">
          <i class="bi bi-plus-circle me-1"></i>Add Data
        </button>
        <a href="{% url 'health_goals' %}" class="btn btn-success btn-sm ms-2">
          <i class="bi bi-bullseye me-1"></i>Set Goals
        </a>
      </div>
    </div>
  </div>

  <!-- Tab Content -->
  <div class="tab-content mt-4" id="overallContent">
    <div class="tab-pane fade show active" id="overall" role="tabpanel" aria-labelledby="overall-tab">
      <div class="row">
        <!-- Steps Record Card -->
        <div class="col-md-4 mb-4">
          <div class="card health-card h-100 text-center">
            <div class="card-header">
              <h5 class="card-title">Steps Record</h5>
            </div>
            <div class="card-body">
              {% if steps_record %}
                <p class="card-text display-4">{{ steps_record.steps_count }}</p>
                <p class="text-muted">Steps</p>
                {% if health_goal and health_goal.daily_steps_goal %}
                  <div class="progress mb-2" style="height: 8px;">
                    {% with progress=steps_record.steps_count|div:health_goal.daily_steps_goal|mul:100|floatformat:0 %}
                    {% with progress_class="progress-width-"|add:progress|slice:"0:17" %}
                    <div class="progress-bar bg-success {{ progress_class }}" role="progressbar" aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100"></div>
                    {% endwith %}
                    {% endwith %}
                  </div>
                  <p class="text-muted small">Goal: {{ health_goal.daily_steps_goal }} steps</p>
                {% endif %}
              {% else %}
                <p class="card-text display-4">0</p>
                <p class="text-muted">No step data today</p>
                {% if health_goal and health_goal.daily_steps_goal %}
                  <p class="text-muted small">Goal: {{ health_goal.daily_steps_goal }} steps</p>
                {% endif %}
              {% endif %}
              <div class="mt-3">
                <a href="{% url 'steps_history' %}" class="btn btn-outline-primary">
                  <i class="bi bi-clock-history me-1"></i> View History
                </a>
                {% if steps_record %}
                  <a href="{% url 'steps_edit' steps_record.id %}" class="btn btn-outline-secondary">
                    <i class="bi bi-pencil me-1"></i> Edit
                  </a>
                {% else %}
                  <a href="{% url 'steps_add' %}" class="btn btn-outline-success">
                    <i class="bi bi-plus-lg me-1"></i> Add
                  </a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Sleep Record Card -->
        <div class="col-md-4 mb-4">
          <div class="card health-card h-100 text-center">
            <div class="card-header">
              <h5 class="card-title">Sleep Record</h5>
            </div>
            <div class="card-body">
              {% if sleep_record %}
                <p class="card-text display-4">{{ sleep_record.hours }}h {{ sleep_record.minutes }}min</p>
                <p class="text-muted">Quality: {{ sleep_record.quality|default:"Not specified" }}</p>
                {% if health_goal and health_goal.daily_sleep_hours_goal %}
                  {% with sleep_minutes=sleep_record.hours|mul:60|add:sleep_record.minutes %}
                  {% with goal_minutes=health_goal.daily_sleep_hours_goal|mul:60|add:health_goal.daily_sleep_minutes_goal %}
                  {% with progress=sleep_minutes|div:goal_minutes|mul:100|floatformat:0 %}
                  <div class="progress mb-2" style="height: 8px;">
                    {% with progress_class="progress-width-"|add:progress|slice:"0:17" %}
                    <div class="progress-bar bg-info {{ progress_class }}" role="progressbar" aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100"></div>
                    {% endwith %}
                  </div>
                  <p class="text-muted small">Goal: {{ health_goal.daily_sleep_hours_goal }}h {{ health_goal.daily_sleep_minutes_goal }}min</p>
                  {% endwith %}
                  {% endwith %}
                  {% endwith %}
                {% endif %}
              {% else %}
                <p class="card-text display-4">0h 0min</p>
                <p class="text-muted">No sleep data today</p>
                {% if health_goal and health_goal.daily_sleep_hours_goal %}
                  <p class="text-muted small">Goal: {{ health_goal.daily_sleep_hours_goal }}h {{ health_goal.daily_sleep_minutes_goal }}min</p>
                {% endif %}
              {% endif %}
              <div class="mt-3">
                <a href="{% url 'sleep_history' %}" class="btn btn-outline-primary">
                  <i class="bi bi-clock-history me-1"></i> View History
                </a>
                {% if sleep_record %}
                  <a href="{% url 'sleep_edit' sleep_record.id %}" class="btn btn-outline-secondary">
                    <i class="bi bi-pencil me-1"></i> Edit
                  </a>
                {% else %}
                  <a href="{% url 'sleep_add' %}" class="btn btn-outline-success">
                    <i class="bi bi-plus-lg me-1"></i> Add
                  </a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Diet Record Card -->
        <div class="col-md-4 mb-4">
          <div class="card health-card h-100 text-center">
            <div class="card-header">
              <h5 class="card-title">Diet</h5>
            </div>
            <div class="card-body">
              {% if diet_record %}
                <p class="card-text display-4">{{ diet_record.calories }}</p>
                <p class="text-muted">Calories</p>
                {% if health_goal and health_goal.daily_calories_goal %}
                  {% with progress=diet_record.calories|div:health_goal.daily_calories_goal|mul:100|floatformat:0 %}
                  <div class="progress mb-2" style="height: 8px;">
                    {% with progress_class="progress-width-"|add:progress|slice:"0:17" %}
                    <div class="progress-bar bg-warning {{ progress_class }}" role="progressbar" aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100"></div>
                    {% endwith %}
                  </div>
                  <p class="text-muted small">Goal: {{ health_goal.daily_calories_goal }} calories</p>
                  {% endwith %}
                {% endif %}
              {% else %}
                <p class="card-text display-4">0</p>
                <p class="text-muted">No diet data today</p>
                {% if health_goal and health_goal.daily_calories_goal %}
                  <p class="text-muted small">Goal: {{ health_goal.daily_calories_goal }} calories</p>
                {% endif %}
              {% endif %}
              <div class="mt-3">
                <a href="{% url 'diet_history' %}" class="btn btn-outline-primary">
                  <i class="bi bi-clock-history me-1"></i> View History
                </a>
                {% if diet_record %}
                  <a href="{% url 'diet_edit' diet_record.id %}" class="btn btn-outline-secondary">
                    <i class="bi bi-pencil me-1"></i> Edit
                  </a>
                {% else %}
                  <a href="{% url 'diet_add' %}" class="btn btn-outline-success">
                    <i class="bi bi-plus-lg me-1"></i> Add
                  </a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Running Record Card -->
        <div class="col-md-4 mb-4">
          <div class="card health-card h-100 text-center">
            <div class="card-header">
              <h5 class="card-title">Running</h5>
            </div>
            <div class="card-body">
              {% if running_record %}
                <p class="card-text display-4">{{ running_record.distance }} km</p>
                <p class="text-muted">{{ running_record.duration_minutes }} min | {{ running_record.calories_burned }} calories</p>
                {% if health_goal and health_goal.weekly_running_distance_goal %}
                  <p class="text-muted small">Weekly Goal: {{ health_goal.weekly_running_distance_goal }} km</p>
                {% endif %}
              {% else %}
                <p class="card-text display-4">0 km</p>
                <p class="text-muted">No running data today</p>
              {% endif %}
              <div class="mt-3">
                <a href="{% url 'running_history' %}" class="btn btn-outline-primary">
                  <i class="bi bi-clock-history me-1"></i> View History
                </a>
                {% if running_record %}
                  <a href="{% url 'running_edit' running_record.id %}" class="btn btn-outline-secondary">
                    <i class="bi bi-pencil me-1"></i> Edit
                  </a>
                {% else %}
                  <a href="{% url 'running_add' %}" class="btn btn-outline-success">
                    <i class="bi bi-plus-lg me-1"></i> Add
                  </a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Training Record Card -->
        <div class="col-md-4 mb-4">
          <div class="card health-card h-100 text-center">
            <div class="card-header">
              <h5 class="card-title">Training</h5>
            </div>
            <div class="card-body">
              {% if training_record %}
                <p class="card-text display-4">{{ training_record.exercise_type }}</p>
                <p class="text-muted">
                  {% if training_record.sets %}Sets: {{ training_record.sets }}{% endif %}
                  {% if training_record.reps %}Reps: {{ training_record.reps }}{% endif %}
                </p>
                {% if health_goal and health_goal.weekly_training_sessions_goal %}
                  <p class="text-muted small">Weekly Goal: {{ health_goal.weekly_training_sessions_goal }} sessions</p>
                {% endif %}
              {% else %}
                <p class="card-text display-4">-</p>
                <p class="text-muted">No training today</p>
              {% endif %}
              <div class="mt-3">
                <a href="{% url 'training_history' %}" class="btn btn-outline-primary">
                  <i class="bi bi-clock-history me-1"></i> View History
                </a>
                <a href="{% url 'training_add' %}" class="btn btn-outline-success">
                  <i class="bi bi-plus-lg me-1"></i> Add
                </a>
              </div>
            </div>
          </div>
        </div>

        <!-- Mood Record Card -->
        <div class="col-md-4 mb-4">
          <div class="card health-card h-100 text-center">
            <div class="card-header">
              <h5 class="card-title">Mood</h5>
            </div>
            <div class="card-body">
              {% if mood_record %}
                <p class="card-text display-4">
                  {% if mood_record.mood == 'excellent' %}😁
                  {% elif mood_record.mood == 'good' %}😊
                  {% elif mood_record.mood == 'neutral' %}😐
                  {% elif mood_record.mood == 'bad' %}😔
                  {% elif mood_record.mood == 'terrible' %}😢
                  {% endif %}
                </p>
                <p class="text-muted">{{ mood_record.mood|title }}</p>
              {% else %}
                <p class="card-text display-4">😶</p>
                <p class="text-muted">No mood data today</p>
              {% endif %}
              <div class="mt-3">
                <a href="{% url 'mood_history' %}" class="btn btn-outline-primary">
                  <i class="bi bi-clock-history me-1"></i> View History
                </a>
                <a href="{% url 'mood_add' %}" class="btn btn-outline-success">
                  <i class="bi bi-plus-lg me-1"></i> Add
                </a>
              </div>
            </div>
          </div>
        </div>

        <!-- Weight Record Card -->
        <div class="col-md-4 mb-4">
          <div class="card health-card h-100 text-center">
            <div class="card-header">
              <h5 class="card-title">Weight</h5>
            </div>
            <div class="card-body">
              {% if weight_record %}
                <p class="card-text display-4">{{ weight_record.weight }} kg</p>
                <p class="text-muted">
                  Height: {{ weight_record.height }} cm | BMI: {{ weight_record.bmi }} ({{ weight_record.bmi_category }})
                </p>
                {% if health_goal and health_goal.target_weight %}
                  {% with diff=weight_record.weight|sub:health_goal.target_weight %}
                  {% if diff > 0 %}
                    <p class="text-muted small">{{ diff|floatformat:1 }} kg to lose to reach target ({{ health_goal.target_weight }} kg)</p>
                  {% elif diff < 0 %}
                    <p class="text-muted small">{{ diff|abs|floatformat:1 }} kg to gain to reach target ({{ health_goal.target_weight }} kg)</p>
                  {% else %}
                    <p class="text-success small">You've reached your target weight!</p>
                  {% endif %}
                  {% endwith %}
                {% endif %}
              {% else %}
                <p class="card-text display-4">- kg</p>
                <p class="text-muted">No weight data today</p>
                {% if health_goal and health_goal.target_weight %}
                  <p class="text-muted small">Target: {{ health_goal.target_weight }} kg</p>
                {% endif %}
              {% endif %}
              <div class="mt-3">
                <a href="{% url 'weight_history' %}" class="btn btn-outline-primary">
                  <i class="bi bi-clock-history me-1"></i> View History
                </a>
                {% if weight_record %}
                  <a href="{% url 'weight_edit' weight_record.id %}" class="btn btn-outline-secondary">
                    <i class="bi bi-pencil me-1"></i> Edit
                  </a>
                {% else %}
                  <a href="{% url 'weight_add' %}" class="btn btn-outline-success">
                    <i class="bi bi-plus-lg me-1"></i> Add
                  </a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Other tabs content -->
    <div class="tab-pane fade" id="running" role="tabpanel" aria-labelledby="running-tab">
      <div class="chart-container">
        <canvas id="runningChart"></canvas>
      </div>
      <div class="row justify-content-center">
        <div class="col-md-6">
          <div class="card health-card h-100 text-center">
            <div class="card-header">
              <span>🏃‍♂️</span>
              <h5 class="card-title">Running Details</h5>
            </div>
            <div class="card-body">
              {% if running_record %}
                <p class="card-text display-4">{{ running_record.distance }} km</p>
                <p class="text-muted">Duration: {{ running_record.duration }} min</p>
                <p class="text-muted">Calories Burned: {{ running_record.calories_burned }}</p>
              {% else %}
                <div class="empty-state">
                  <i class="bi bi-lightning"></i>
                  <h5>No Running Data</h5>
                  <p>Start tracking your running to see statistics here</p>
                  <a href="{% url 'running_add' %}" class="btn btn-outline-success mt-3">
                    <i class="bi bi-plus-lg me-1"></i> Add Running Record
                  </a>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Other tabs similar structure -->
    <div class="tab-pane fade" id="steps" role="tabpanel" aria-labelledby="steps-tab">
      <!-- Steps tab content -->
    </div>
    
    <div class="tab-pane fade" id="training" role="tabpanel" aria-labelledby="training-tab">
      <!-- Training tab content -->
    </div>
    
    <div class="tab-pane fade" id="sleep" role="tabpanel" aria-labelledby="sleep-tab">
      <!-- Sleep tab content -->
    </div>
    
    <div class="tab-pane fade" id="diet" role="tabpanel" aria-labelledby="diet-tab">
      <!-- Diet tab content -->
    </div>
    
    <div class="tab-pane fade" id="mood" role="tabpanel" aria-labelledby="mood-tab">
      <!-- Mood tab content -->
    </div>
  </div>
</div>

<!-- Add Data Modal -->
<div class="modal fade" id="addDataModal" tabindex="-1" aria-labelledby="addDataModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addDataModalLabel">Add Health Data</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Select the type of health data to add:</p>
        <div class="list-group">
          <a href="{% url 'steps_add' %}" class="list-group-item list-group-item-action d-flex align-items-center">
            <i class="bi bi-activity me-3 text-primary"></i> Steps
          </a>
          <a href="{% url 'sleep_add' %}" class="list-group-item list-group-item-action d-flex align-items-center">
            <i class="bi bi-moon me-3 text-primary"></i> Sleep
          </a>
          <a href="{% url 'diet_add' %}" class="list-group-item list-group-item-action d-flex align-items-center">
            <i class="bi bi-egg-fried me-3 text-primary"></i> Diet
          </a>
          <a href="{% url 'running_add' %}" class="list-group-item list-group-item-action d-flex align-items-center">
            <i class="bi bi-lightning me-3 text-primary"></i> Running
          </a>
          <a href="{% url 'training_add' %}" class="list-group-item list-group-item-action d-flex align-items-center">
            <i class="bi bi-trophy me-3 text-primary"></i> Training
          </a>
          <a href="{% url 'mood_add' %}" class="list-group-item list-group-item-action d-flex align-items-center">
            <i class="bi bi-emoji-smile me-3 text-primary"></i> Mood
          </a>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block javascript %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/health.js' %}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const menuToggle = document.querySelector('.menu-toggle');
    if (menuToggle) {
      menuToggle.addEventListener('click', function() {
        document.body.classList.toggle('sidebar-expanded');
      });
    }
    
    // 确保内容正确显示
    const tabContent = document.getElementById('overallContent');
    if (tabContent) {
      tabContent.style.display = 'block';
    }
    
    // 初始化图表
    if (document.getElementById('runningChart')) {
      const ctx = document.getElementById('runningChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
          datasets: [{
            label: 'Distance (km)',
            data: [5, 3, 0, 7, 2, 8, 4],
            borderColor: '#0d6efd',
            backgroundColor: 'rgba(13, 110, 253, 0.1)',
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            title: {
              display: true,
              text: 'Running Distance This Week'
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }
    
    // 彻底解决导航链接需要点击两次的问题
    // 1. 获取所有导航链接
    const navLinks = document.querySelectorAll('#healthTabs .nav-link');
    
    // 2. 为每个链接创建一个克隆，并替换原来的链接
    navLinks.forEach(link => {
      // 创建一个新链接元素
      const newLink = document.createElement('a');
      
      // 复制原链接的所有属性
      newLink.className = link.className;
      newLink.href = link.href;
      newLink.innerHTML = link.innerHTML;
      
      // 确保链接可以正常工作，禁用Bootstrap的tab功能
      newLink.setAttribute('data-bs-toggle', '');
      
      // 替换原来的链接
      link.parentNode.replaceChild(newLink, link);
    });
    
    // 3. 根据当前URL自动设置active类
    function setActiveNavLink() {
      // 获取当前页面URL路径
      const currentPath = window.location.pathname;
      
      // 获取所有已替换的导航链接
      const allNavLinks = document.querySelectorAll('#healthTabs a');
      
      // 移除所有链接的active类
      allNavLinks.forEach(navLink => {
        navLink.classList.remove('active');
      });
      
      // 为匹配当前URL的链接添加active类
      allNavLinks.forEach(navLink => {
        const linkPath = navLink.getAttribute('href');
        if (currentPath === linkPath || 
           (currentPath === '/' && linkPath.includes('dashboard')) || 
           (currentPath.includes(linkPath) && linkPath !== '/')) {
          navLink.classList.add('active');
        }
      });
    }
    
    // 页面加载时设置active类
    setActiveNavLink();
    
    // 点击导航链接时处理active类
    document.querySelectorAll('#healthTabs a').forEach(link => {
      link.addEventListener('click', function() {
        // 移除所有链接的active类
        document.querySelectorAll('#healthTabs a').forEach(l => {
          l.classList.remove('active');
        });
        
        // 添加active类到当前点击的链接
        this.classList.add('active');
      });
    });
  });
</script>
{% endblock %} 