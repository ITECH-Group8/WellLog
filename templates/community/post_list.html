{% extends 'base_with_sidebar.html' %}

{% block title %}Community{% endblock %}

{% block css %}
{{ block.super }}
<style>
  /* Post Grid */
  .post-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 30px;
  }
  
  /* Post Card */
  .post-card {
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    overflow: hidden;
    transition: transform 0.3s, box-shadow 0.3s;
  }
  
  .post-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.15);
  }
  
  .post-image {
    width: 100%;
    height: 180px;
    object-fit: cover;
  }
  
  .post-content {
    padding: 20px;
  }
  
  .post-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 10px;
    line-height: 1.3;
  }
  
  .post-text {
    color: #6c757d;
    font-size: 0.9rem;
    margin-bottom: 15px;
    line-height: 1.5;
  }
  
  .post-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 15px;
    font-size: 0.8rem;
    color: #6c757d;
  }
  
  .post-author {
    display: flex;
    align-items: center;
  }
  
  .author-avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    margin-right: 8px;
    object-fit: cover;
  }
  
  .post-stats {
    display: flex;
    align-items: center;
  }
  
  .stat-item {
    display: flex;
    align-items: center;
    margin-left: 12px;
  }
  
  .stat-item i {
    margin-right: 5px;
    font-size: 1rem;
  }
  
  /* Community Header */
  .community-header {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 10px;
  }
  
  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 50px 20px;
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
  }
  
  /* Create Post Button */
  .create-post-fab {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    background-color: #0d6efd;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    z-index: 1000;
    transition: all 0.3s;
  }
  
  .create-post-fab:hover {
    background-color: #0b5ed7;
    transform: scale(1.05);
  }
  
  .create-post-fab i {
    font-size: 1.5rem;
  }
  
  /* Error Message */
  .error-message {
    background-color: #f8d7da;
    color: #721c24;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    text-align: center;
  }
  
  /* Image Placeholder */
  .image-placeholder {
    height: 180px;
    background-color: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  /* Media Queries for Responsiveness */
  @media (max-width: 768px) {
    .post-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<!-- Error messages -->
{% if error %}
<div class="error-message">
  <i class="bi bi-exclamation-triangle-fill me-2"></i>
  {{ error }}
</div>
{% endif %}

{% if messages %}
<div class="messages">
  {% for message in messages %}
  <div class="alert alert-{{ message.tags }}">
    {{ message }}
  </div>
  {% endfor %}
</div>
{% endif %}

<!-- Community Header -->
<div class="community-header text-center">
  <h1>Fitness Community</h1>
  <p class="text-muted">Share your fitness journey with others and get inspired</p>
  <div class="d-flex justify-content-center mt-3">
    <a href="{% url 'post_create' %}" class="btn btn-primary me-2">
      <i class="bi bi-plus-circle me-1"></i> Create Post
    </a>
    <button class="btn btn-outline-secondary">
      <i class="bi bi-funnel me-1"></i> Filter
    </button>
  </div>
</div>

<!-- Post Grid -->
{% if posts %}
  <div class="post-grid">
    {% for post in posts %}
      <div class="post-card">
        <a href="{% url 'post_detail' post.id %}" class="text-decoration-none text-dark">
          {% if post.image_url %}
            <div class="image-placeholder" id="placeholder-{{ post.id }}">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
            <img src="{{ post.thumbnail_url }}" class="post-image" alt="{{ post.title }}" style="display:none;" 
                 onload="handleThumbnailLoaded(this, '{{ post.id }}')" 
                 onerror="handleThumbnailError(this, '{{ post.id }}')">
            <script>
              function handleThumbnailLoaded(img, postId) {
                var placeholder = document.getElementById('placeholder-' + postId);
                if (placeholder) {
                  placeholder.style.display = 'none';
                }
                img.style.display = 'block';
                console.log('Thumbnail loaded successfully: ' + postId);
              }
              
              function handleThumbnailError(img, postId) {
                var placeholder = document.getElementById('placeholder-' + postId);
                if (placeholder) {
                  placeholder.innerHTML = '<i class="bi bi-exclamation-triangle" style="font-size: 2rem; color: #dc3545;"></i>';
                }
                img.style.display = 'none';
                console.error('Thumbnail loading failed: ' + postId);
              }
              
              // Check if image is already loaded (from cache)
              document.addEventListener('DOMContentLoaded', function() {
                var img = document.querySelector('img[alt="{{ post.title }}"]');
                if (img && img.complete) {
                  console.log('Thumbnail loaded from cache');
                  if (img.naturalWidth === 0) {
                    handleThumbnailError(img, '{{ post.id }}');
                  } else {
                    handleThumbnailLoaded(img, '{{ post.id }}');
                  }
                }
              });
            </script>
          {% else %}
            <div class="bg-light d-flex align-items-center justify-content-center" style="height: 180px;">
              <i class="bi bi-card-text" style="font-size: 3rem; color: #dee2e6;"></i>
            </div>
          {% endif %}
          <div class="post-content">
            <h3 class="post-title">{{ post.title }}</h3>
            <p class="post-text">{{ post.content|truncatechars:100 }}</p>
            <div class="post-meta">
              <div class="post-author">
                {% if post.author.profile and post.author.profile.avatar_url %}
                  <img src="{{ post.author.profile.avatar_url }}" class="author-avatar" alt="{{ post.author.username }}">
                {% else %}
                  <div class="author-avatar d-flex align-items-center justify-content-center bg-secondary text-white">
                    {{ post.author.username|first|upper }}
                  </div>
                {% endif %}
                <span>{{ post.author.username }}</span>
              </div>
              <div class="post-stats">
                <div class="stat-item like-display" data-post-id="{{ post.id }}">
                  <i class="bi bi-heart{% if post.user_liked %}-fill text-danger{% endif %}"></i>
                  <span class="post-like-count">{{ post.like_count }}</span>
                </div>
                <div class="stat-item">
                  <i class="bi bi-chat"></i>
                  <span>{{ post.comment_count }}</span>
                </div>
              </div>
            </div>
          </div>
        </a>
      </div>
    {% endfor %}
  </div>
{% else %}
  <div class="empty-state">
    <i class="bi bi-journal-text" style="font-size: 4rem; color: #ddd;"></i>
    <h3 class="mt-3">No posts yet</h3>
    <p>Be the first to share your fitness journey!</p>
    <a href="{% url 'post_create' %}" class="btn btn-primary mt-2">
      <i class="bi bi-plus-circle me-1"></i> Create Post
    </a>
  </div>
{% endif %}

<!-- Mobile Add Post Button -->
<a href="{% url 'post_create' %}" class="create-post-fab d-md-none">
  <i class="bi bi-plus-lg"></i>
</a>
{% endblock %}

{% block javascript %}
{{ block.super }}
{% endblock %} 