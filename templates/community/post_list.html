{% extends 'base_with_sidebar.html' %}

{% block title %}Community{% endblock %}

{% block css %}
{{ block.super }}
<style>
  .post-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }
  
  .post-card {
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
    position: relative;
    background-color: #fff;
  }
  
  .post-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  }
  
  .post-image {
    width: 100%;
    height: 220px;
    object-fit: cover;
  }
  
  .post-content {
    padding: 15px;
  }
  
  .post-title {
    font-weight: 600;
    margin-bottom: 10px;
    font-size: 18px;
    line-height: 1.4;
    max-height: 50px;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }
  
  .post-text {
    color: #666;
    font-size: 14px;
    margin-bottom: 15px;
    max-height: 60px;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
  }
  
  .post-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
    color: #999;
  }
  
  .post-author {
    display: flex;
    align-items: center;
  }
  
  .author-avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    margin-right: 10px;
    object-fit: cover;
    background-color: #f0f0f0;
  }
  
  .post-stats {
    display: flex;
    gap: 15px;
  }
  
  .stat-item {
    display: flex;
    align-items: center;
    gap: 4px;
  }
  
  .community-header {
    background-color: #f8f9fa;
    padding: 30px 0;
    margin-bottom: 20px;
    border-radius: 10px;
  }
  
  .empty-state {
    text-align: center;
    padding: 50px 0;
    color: #888;
  }
  
  .create-post-fab {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background-color: #0d6efd;
    color: white;
    font-size: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    z-index: 1000;
    transition: all 0.2s ease;
  }
  
  .create-post-fab:hover {
    transform: scale(1.1);
    background-color: #0b5ed7;
    color: white;
  }
  
  .error-message {
    background-color: #f8d7da;
    color: #721c24;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    text-align: center;
  }
  
  .image-placeholder {
    width: 100%;
    height: 220px;
    background-color: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
  }
</style>
{% endblock %}

{% block content %}
<!-- Error messages -->
{% if error %}
<div class="error-message">
  <i class="bi bi-exclamation-triangle-fill me-2"></i>
  {{ error }}
</div>
{% endif %}

{% if messages %}
<div class="messages">
  {% for message in messages %}
  <div class="alert alert-{{ message.tags }}">
    {{ message }}
  </div>
  {% endfor %}
</div>
{% endif %}

<!-- Community Header -->
<div class="community-header text-center">
  <h1>Fitness Community</h1>
  <p class="text-muted">Share your fitness journey with others and get inspired</p>
  <div class="d-flex justify-content-center mt-3">
    <a href="{% url 'post_create' %}" class="btn btn-primary me-2">
      <i class="bi bi-plus-circle me-1"></i> Create Post
    </a>
    <button class="btn btn-outline-secondary">
      <i class="bi bi-funnel me-1"></i> Filter
    </button>
  </div>
</div>

<!-- Post Grid -->
{% if posts %}
  <div class="post-grid">
    {% for post in posts %}
      <div class="post-card">
        <a href="{% url 'post_detail' post.id %}" class="text-decoration-none text-dark">
          {% if post.image_url %}
            <div class="image-placeholder">
              <i class="bi bi-image" style="font-size: 2rem; color: #adb5bd;"></i>
            </div>
            <img data-src="{{ post.thumbnail_url }}" class="post-image lazy-load" alt="{{ post.title }}" style="display: none;">
          {% else %}
            <div class="bg-light d-flex align-items-center justify-content-center" style="height: 180px;">
              <i class="bi bi-card-text" style="font-size: 3rem; color: #dee2e6;"></i>
            </div>
          {% endif %}
          <div class="post-content">
            <h3 class="post-title">{{ post.title }}</h3>
            <p class="post-text">{{ post.content|truncatechars:100 }}</p>
            <div class="post-meta">
              <div class="post-author">
                {% if post.author.profile and post.author.profile.avatar_url %}
                  <img src="{{ post.author.profile.avatar_url }}" class="author-avatar" alt="{{ post.author.username }}">
                {% else %}
                  <div class="author-avatar d-flex align-items-center justify-content-center bg-secondary text-white">
                    {{ post.author.username|first|upper }}
                  </div>
                {% endif %}
                <span>{{ post.author.username }}</span>
              </div>
              <div class="post-stats">
                <div class="stat-item">
                  <i class="bi bi-heart"></i>
                  <span>{{ post.like_count }}</span>
                </div>
                <div class="stat-item">
                  <i class="bi bi-chat"></i>
                  <span>{{ post.comment_count }}</span>
                </div>
              </div>
            </div>
          </div>
        </a>
      </div>
    {% endfor %}
  </div>
{% else %}
  <div class="empty-state">
    <i class="bi bi-journal-text" style="font-size: 4rem; color: #ddd;"></i>
    <h3 class="mt-3">No posts yet</h3>
    <p>Be the first to share your fitness journey!</p>
    <a href="{% url 'post_create' %}" class="btn btn-primary mt-2">
      <i class="bi bi-plus-circle me-1"></i> Create Post
    </a>
  </div>
{% endif %}

<!-- Mobile Add Post Button -->
<a href="{% url 'post_create' %}" class="create-post-fab d-md-none">
  <i class="bi bi-plus-lg"></i>
</a>
{% endblock %}

{% block javascript %}
{{ block.super }}
<script>
  // Lazy loading for images
  document.addEventListener("DOMContentLoaded", function() {
    const lazyImages = [].slice.call(document.querySelectorAll("img.lazy-load"));
    
    if ("IntersectionObserver" in window) {
      let lazyImageObserver = new IntersectionObserver(function(entries, observer) {
        entries.forEach(function(entry) {
          if (entry.isIntersecting) {
            let lazyImage = entry.target;
            lazyImage.src = lazyImage.dataset.src;
            lazyImage.style.display = "block";
            lazyImage.previousElementSibling.style.display = "none"; // Hide placeholder
            lazyImage.classList.remove("lazy-load");
            lazyImageObserver.unobserve(lazyImage);
          }
        });
      });
      
      lazyImages.forEach(function(lazyImage) {
        lazyImageObserver.observe(lazyImage);
      });
    } else {
      // Fallback for browsers that don't support IntersectionObserver
      lazyImages.forEach(function(lazyImage) {
        lazyImage.src = lazyImage.dataset.src;
        lazyImage.style.display = "block";
        lazyImage.previousElementSibling.style.display = "none";
        lazyImage.classList.remove("lazy-load");
      });
    }
  });
</script>
{% endblock %} 